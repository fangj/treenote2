'use strict';

var express = require('express');
var router = express.Router();
var fs = require('bluebird').promisifyAll(require('fs-extra'));
var path = require('path');
var _ = require('lodash');
var logger = require('log4js').getLogger('server');
logger.setLevel('DEBUG'); //程序完成后注释掉。可以切换回默认等级，减少log

function factory(config) {
  var tree;
  if (config.mongodb) {
    tree = require('../tree-mongodb')(config.mongodb);
  } else if (config.nedb) {
    tree = require('../tree-nedb')(config.nedb);
  } else if (config.leancloud) {
    tree = require('../tree-leancloud')(config.leancloud);
  }

  router.post('/nodes', function (req, res, next) {
    tree.read_nodes(req.body).then(function (nodes) {
      res.json(nodes);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son/:gid', function (req, res, next) {
    // logger.debug(req.body);

    tree.mk_son_by_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son_name/:gid', function (req, res, next) {
    // logger.debug(req.body);

    tree.mk_son_by_name(req.params.gid, req.body.name).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/brother/:bgid', function (req, res, next) {
    // res.send('mk brother of'+req.params.bgid);
    tree.mk_brother_by_data(req.body, req.params.bgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/son/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as son of ${p.dgid}`);
    tree.move_as_son(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/brother/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as brother of ${p.dgid}`);
    tree.move_as_brother(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function expand(node, level) {
    //level用于控制展开的层级
    if (node._link.children.length == 0 || level <= 0) {
      //不做展开的2种情况。1.没有子节点。2，展开层级小于0
      var cloneNode = clone(node);
      cloneNode._children = [];
      return Promise.resolve(cloneNode);
    } else {
      return tree.read_nodes(node._link.children).then(function (nodes) {
        // logger.debug('children:',node._link.children,'nodes',nodes)
        var fnodes = nodes.map(function (node) {
          return expand(node, level - 1);
        });
        return Promise.all(fnodes).then(function (nodes) {
          var cloneNode = clone(node);
          cloneNode._children = nodes || []; //展开的节点放到_children中
          return cloneNode;
        });
      });
    }
  }

  function read_bignode(gid, level) {
    return tree.read_node(gid).then(function (node) {
      return expand(node, level);
    });
  }

  /* GET api . */
  router.get('/:gid', function (req, res, next) {
    tree.read_node(req.params.gid).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  /* GET expanded node  . */
  router.get('/bignode/:gid/:level', function (req, res, next) {
    read_bignode(req.params.gid, req.params.level).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.put('/:gid', function (req, res, next) {
    tree.update_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
      save2elasticsearch(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.delete('/:gid', function (req, res, next) {
    tree.remove(req.params.gid).then(function () {
      res.json([req.params.gid]);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  return router;
}

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvbWlkZGxld2FyZS90cmVlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxVQUFVLFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSSxTQUFTLFFBQVEsTUFBUixFQUFiO0FBQ0EsSUFBSSxLQUFLLFFBQVEsVUFBUixFQUFvQixZQUFwQixDQUFpQyxRQUFRLFVBQVIsQ0FBakMsQ0FBVDtBQUNBLElBQUksT0FBSyxRQUFRLE1BQVIsQ0FBVDtBQUNBLElBQUksSUFBRSxRQUFRLFFBQVIsQ0FBTjtBQUNBLElBQUksU0FBUyxRQUFRLFFBQVIsRUFBa0IsU0FBbEIsQ0FBNEIsUUFBNUIsQ0FBYjtBQUNBLE9BQU8sUUFBUCxDQUFnQixPQUFoQixFLENBQTBCOztBQUUxQixTQUFTLE9BQVQsQ0FBaUIsTUFBakIsRUFBeUI7QUFDdkIsTUFBSSxJQUFKO0FBQ0EsTUFBRyxPQUFPLE9BQVYsRUFBa0I7QUFDaEIsV0FBTyxRQUFRLGlCQUFSLEVBQTJCLE9BQU8sT0FBbEMsQ0FBUDtBQUNELEdBRkQsTUFFTSxJQUFHLE9BQU8sSUFBVixFQUFlO0FBQ25CLFdBQU8sUUFBUSxjQUFSLEVBQXdCLE9BQU8sSUFBL0IsQ0FBUDtBQUNELEdBRkssTUFFQSxJQUFHLE9BQU8sU0FBVixFQUFvQjtBQUN4QixXQUFPLFFBQVEsbUJBQVIsRUFBNkIsT0FBTyxTQUFwQyxDQUFQO0FBQ0Q7O0FBRUQsU0FBTyxJQUFQLENBQVksUUFBWixFQUNFLFVBQVMsR0FBVCxFQUFjLEdBQWQsRUFBbUIsSUFBbkIsRUFBeUI7QUFDekIsU0FBSyxVQUFMLENBQWdCLElBQUksSUFBcEIsRUFBMEIsSUFBMUIsQ0FBK0IsaUJBQVM7QUFDdEMsVUFBSSxJQUFKLENBQVMsS0FBVDtBQUNELEtBRkQsRUFFRyxLQUZILENBRVMsYUFBSztBQUNaLGFBQU8sS0FBUCxDQUFhLENBQWI7QUFDQSxVQUFJLE1BQUosQ0FBVyxHQUFYLEVBQWdCLEdBQWhCO0FBQ0QsS0FM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QUFDRCxLQUxEO0FBTUQsR0FSRDs7QUFVQSxTQUFPLE1BQVA7QUFDRDs7QUFFRCxPQUFPLE9BQVAsR0FBaUIsT0FBakIiLCJmaWxlIjoidHJlZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xyXG52YXIgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcclxudmFyIGZzID0gcmVxdWlyZSgnYmx1ZWJpcmQnKS5wcm9taXNpZnlBbGwocmVxdWlyZSgnZnMtZXh0cmEnKSk7XHJcbnZhciBwYXRoPXJlcXVpcmUoJ3BhdGgnKTtcclxudmFyIF89cmVxdWlyZSgnbG9kYXNoJyk7XHJcbnZhciBsb2dnZXIgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoJ3NlcnZlcicpO1xyXG5sb2dnZXIuc2V0TGV2ZWwoJ0RFQlVHJyk7IC8v56iL5bqP5a6M5oiQ5ZCO5rOo6YeK5o6J44CC5Y+v5Lul5YiH5o2i5Zue6buY6K6k562J57qn77yM5YeP5bCRbG9nXHJcblxyXG5mdW5jdGlvbiBmYWN0b3J5KGNvbmZpZykge1xyXG4gIHZhciB0cmVlO1xyXG4gIGlmKGNvbmZpZy5tb25nb2RiKXtcclxuICAgIHRyZWUgPSByZXF1aXJlKCcuLi90cmVlLW1vbmdvZGInKShjb25maWcubW9uZ29kYik7XHJcbiAgfWVsc2UgaWYoY29uZmlnLm5lZGIpe1xyXG4gICAgdHJlZSA9IHJlcXVpcmUoJy4uL3RyZWUtbmVkYicpKGNvbmZpZy5uZWRiKTtcclxuICB9ZWxzZSBpZihjb25maWcubGVhbmNsb3VkKXtcclxuICAgIHRyZWUgPSByZXF1aXJlKCcuLi90cmVlLWxlYW5jbG91ZCcpKGNvbmZpZy5sZWFuY2xvdWQpO1xyXG4gIH1cclxuXHJcbiAgcm91dGVyLnBvc3QoJy9ub2RlcycsIFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHRyZWUucmVhZF9ub2RlcyhyZXEuYm9keSkudGhlbihub2RlcyA9PiB7XHJcbiAgICAgIHJlcy5qc29uKG5vZGVzKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuXHJcbiAgcm91dGVyLnBvc3QoJy9tay9zb24vOmdpZCcsIFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIC8vIGxvZ2dlci5kZWJ1ZyhyZXEuYm9keSk7XHJcblxyXG4gICAgdHJlZS5ta19zb25fYnlfZGF0YShyZXEucGFyYW1zLmdpZCwgcmVxLmJvZHkpLnRoZW4obm9kZSA9PiB7XHJcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcclxuICAgICAgcmVzLmpzb24obm9kZSk7XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgcm91dGVyLnBvc3QoJy9tay9zb25fbmFtZS86Z2lkJywgXHJcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgLy8gbG9nZ2VyLmRlYnVnKHJlcS5ib2R5KTtcclxuXHJcbiAgICB0cmVlLm1rX3Nvbl9ieV9uYW1lKHJlcS5wYXJhbXMuZ2lkLCByZXEuYm9keS5uYW1lKS50aGVuKG5vZGUgPT4ge1xyXG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XHJcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG5cclxuICByb3V0ZXIucG9zdCgnL21rL2Jyb3RoZXIvOmJnaWQnLCBcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAvLyByZXMuc2VuZCgnbWsgYnJvdGhlciBvZicrcmVxLnBhcmFtcy5iZ2lkKTtcclxuICAgIHRyZWUubWtfYnJvdGhlcl9ieV9kYXRhKHJlcS5ib2R5LHJlcS5wYXJhbXMuYmdpZCkudGhlbigobm9kZSkgPT4ge1xyXG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XHJcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG5cclxuICByb3V0ZXIucG9zdCgnL212LzpzZ2lkL3Nvbi86ZGdpZCcsIFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHZhciBwID0gcmVxLnBhcmFtcztcclxuICAgIC8vIGxvZ2dlci5kZWJ1ZyhgbXYgJHtwLnNnaWR9IGFzIHNvbiBvZiAke3AuZGdpZH1gKTtcclxuICAgIHRyZWUubW92ZV9hc19zb24ocC5zZ2lkLHAuZGdpZCkudGhlbihub2RlID0+IHtcclxuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xyXG4gICAgICByZXMuanNvbihub2RlKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICByb3V0ZXIucG9zdCgnL212LzpzZ2lkL2Jyb3RoZXIvOmRnaWQnLCBcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICB2YXIgcCA9IHJlcS5wYXJhbXM7XHJcbiAgICAvLyBsb2dnZXIuZGVidWcoYG12ICR7cC5zZ2lkfSBhcyBicm90aGVyIG9mICR7cC5kZ2lkfWApO1xyXG4gICAgdHJlZS5tb3ZlX2FzX2Jyb3RoZXIocC5zZ2lkLHAuZGdpZCkudGhlbihub2RlID0+IHtcclxuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xyXG4gICAgICByZXMuanNvbihub2RlKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuXHJcbiAgZnVuY3Rpb24gY2xvbmUob2JqKXtcclxuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7XHJcbiAgfVxyXG4gIFxyXG4gIGZ1bmN0aW9uIGV4cGFuZChub2RlLGxldmVsKXsgLy9sZXZlbOeUqOS6juaOp+WItuWxleW8gOeahOWxgue6p1xyXG4gICAgaWYobm9kZS5fbGluay5jaGlsZHJlbi5sZW5ndGg9PTAgfHwgbGV2ZWw8PTAgKXsgLy/kuI3lgZrlsZXlvIDnmoQy56eN5oOF5Ya144CCMS7msqHmnInlrZDoioLngrnjgIIy77yM5bGV5byA5bGC57qn5bCP5LqOMFxyXG4gICAgICAgIHZhciBjbG9uZU5vZGU9Y2xvbmUobm9kZSk7XHJcbiAgICAgICAgY2xvbmVOb2RlLl9jaGlsZHJlbj1bXTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNsb25lTm9kZSk7XHJcbiAgICB9ZWxzZXtcclxuICAgICAgICByZXR1cm4gdHJlZS5yZWFkX25vZGVzKG5vZGUuX2xpbmsuY2hpbGRyZW4pXHJcbiAgICAgICAgLnRoZW4obm9kZXM9PntcclxuICAgICAgICAgIC8vIGxvZ2dlci5kZWJ1ZygnY2hpbGRyZW46Jyxub2RlLl9saW5rLmNoaWxkcmVuLCdub2Rlcycsbm9kZXMpXHJcbiAgICAgICAgICAgIGNvbnN0IGZub2Rlcz1ub2Rlcy5tYXAobm9kZT0+ZXhwYW5kKG5vZGUsbGV2ZWwtMSkpO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZm5vZGVzKS50aGVuKG5vZGVzPT57XHJcbiAgICAgICAgICAgICAgICB2YXIgY2xvbmVOb2RlPWNsb25lKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgY2xvbmVOb2RlLl9jaGlsZHJlbj1ub2Rlc3x8W107IC8v5bGV5byA55qE6IqC54K55pS+5YiwX2NoaWxkcmVu5LitXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmVOb2RlO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiByZWFkX2JpZ25vZGUoZ2lkLGxldmVsKSB7XHJcbiAgICByZXR1cm4gdHJlZS5yZWFkX25vZGUoZ2lkKS50aGVuKFxyXG4gICAgICBub2RlPT5leHBhbmQobm9kZSxsZXZlbClcclxuICAgICk7IFxyXG4gIH1cclxuXHJcbiAgLyogR0VUIGFwaSAuICovXHJcbiAgcm91dGVyLmdldCgnLzpnaWQnLFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHRyZWUucmVhZF9ub2RlKHJlcS5wYXJhbXMuZ2lkKS50aGVuKG5vZGU9PiB7ICAgIFxyXG4gICAgICByZXR1cm4gcmVzLmpzb24obm9kZSk7XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgICAvKiBHRVQgZXhwYW5kZWQgbm9kZSAgLiAqL1xyXG4gIHJvdXRlci5nZXQoJy9iaWdub2RlLzpnaWQvOmxldmVsJyxcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICAgIHJlYWRfYmlnbm9kZShyZXEucGFyYW1zLmdpZCxyZXEucGFyYW1zLmxldmVsKS50aGVuKG5vZGU9PiB7ICAgIFxyXG4gICAgICAgIHJldHVybiByZXMuanNvbihub2RlKTtcclxuICAgICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIHJvdXRlci5wdXQoJy86Z2lkJywgXHJcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgdHJlZS51cGRhdGVfZGF0YShyZXEucGFyYW1zLmdpZCwgcmVxLmJvZHkpLnRoZW4oKG5vZGUpID0+IHtcclxuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xyXG4gICAgICByZXMuanNvbihub2RlKTtcclxuICAgICAgc2F2ZTJlbGFzdGljc2VhcmNoKG5vZGUpO1xyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIHJvdXRlci5kZWxldGUoJy86Z2lkJywgXHJcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgdHJlZS5yZW1vdmUocmVxLnBhcmFtcy5naWQpLnRoZW4oKCkgPT4ge1xyXG4gICAgICByZXMuanNvbihbcmVxLnBhcmFtcy5naWRdKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICByZXR1cm4gcm91dGVyO1xyXG59XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZhY3Rvcnk7Il19