'use strict';

var express = require('express');
var router = express.Router();
var fs = require('bluebird').promisifyAll(require('fs-extra'));
var path = require('path');
var _ = require('lodash');
var logger = require('log4js').getLogger('server');
logger.setLevel('DEBUG'); //程序完成后注释掉。可以切换回默认等级，减少log

function factory(config) {
  var tree;
  if (config.mongodb) {
    tree = require('../tree-mongodb')(config.mongodb);
  } else if (config.nedb) {
    tree = require('../tree-nedb')(config.nedb);
  } else if (config.leancloud) {
    tree = require('../tree-leancloud')(config.leancloud);
  }

  router.post('/nodes', function (req, res, next) {
    tree.read_nodes(req.body).then(function (nodes) {
      res.json(nodes);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son/:gid', function (req, res, next) {
    logger.debug(req.body);

    tree.mk_son_by_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son_name/:gid', function (req, res, next) {
    logger.debug(req.body);

    tree.mk_son_by_name(req.params.gid, req.body.name).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/brother/:bgid', function (req, res, next) {
    // res.send('mk brother of'+req.params.bgid);
    tree.mk_brother_by_data(req.body, req.params.bgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/son/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as son of ${p.dgid}`);
    tree.move_as_son(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/brother/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as brother of ${p.dgid}`);
    tree.move_as_brother(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function expand(node, level) {
    //level用于控制展开的层级
    if (node._link.children.length == 0 || level <= 0) {
      //不做展开的2种情况。1.没有子节点。2，展开层级小于0
      var cloneNode = clone(node);
      cloneNode._children = [];
      return Promise.resolve(cloneNode);
    } else {
      return tree.read_nodes(node._link.children).then(function (nodes) {
        logger.debug('children:', node._link.children, 'nodes', nodes);
        var fnodes = nodes.map(function (node) {
          return expand(node, level - 1);
        });
        return Promise.all(fnodes).then(function (nodes) {
          var cloneNode = clone(node);
          cloneNode._children = nodes || []; //展开的节点放到_children中
          return cloneNode;
        });
      });
    }
  }

  function read_bignode(gid, level) {
    return tree.read_node(gid).then(function (node) {
      return expand(node, level);
    });
  }

  /* GET api . */
  router.get('/:gid', function (req, res, next) {
    tree.read_node(req.params.gid).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  /* GET expanded node  . */
  router.get('/bignode/:gid/:level', function (req, res, next) {
    read_bignode(req.params.gid, req.params.level).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.put('/:gid', function (req, res, next) {
    tree.update_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
      save2elasticsearch(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.delete('/:gid', function (req, res, next) {
    tree.remove(req.params.gid).then(function () {
      res.json([req.params.gid]);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  return router;
}

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvbWlkZGxld2FyZS90cmVlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxVQUFVLFFBQVEsU0FBUixDQUFWO0FBQ0osSUFBSSxTQUFTLFFBQVEsTUFBUixFQUFUO0FBQ0osSUFBSSxLQUFLLFFBQVEsVUFBUixFQUFvQixZQUFwQixDQUFpQyxRQUFRLFVBQVIsQ0FBakMsQ0FBTDtBQUNKLElBQUksT0FBSyxRQUFRLE1BQVIsQ0FBTDtBQUNKLElBQUksSUFBRSxRQUFRLFFBQVIsQ0FBRjtBQUNKLElBQUksU0FBUyxRQUFRLFFBQVIsRUFBa0IsU0FBbEIsQ0FBNEIsUUFBNUIsQ0FBVDtBQUNKLE9BQU8sUUFBUCxDQUFnQixPQUFoQjs7QUFFQSxTQUFTLE9BQVQsQ0FBaUIsTUFBakIsRUFBeUI7QUFDdkIsTUFBSSxJQUFKLENBRHVCO0FBRXZCLE1BQUcsT0FBTyxPQUFQLEVBQWU7QUFDaEIsV0FBTyxRQUFRLGlCQUFSLEVBQTJCLE9BQU8sT0FBUCxDQUFsQyxDQURnQjtHQUFsQixNQUVNLElBQUcsT0FBTyxJQUFQLEVBQVk7QUFDbkIsV0FBTyxRQUFRLGNBQVIsRUFBd0IsT0FBTyxJQUFQLENBQS9CLENBRG1CO0dBQWYsTUFFQSxJQUFHLE9BQU8sU0FBUCxFQUFpQjtBQUN4QixXQUFPLFFBQVEsbUJBQVIsRUFBNkIsT0FBTyxTQUFQLENBQXBDLENBRHdCO0dBQXBCOztBQUlOLFNBQU8sSUFBUCxDQUFZLFFBQVosRUFDRSxVQUFTLEdBQVQsRUFBYyxHQUFkLEVBQW1CLElBQW5CLEVBQXlCO0FBQ3pCLFNBQUssVUFBTCxDQUFnQixJQUFJLElBQUosQ0FBaEIsQ0FBMEIsSUFBMUIsQ0FBK0IsaUJBQVM7QUFDdEMsVUFBSSxJQUFKLENBQVMsS0FBVCxFQURzQztLQUFULENBQS9CLENBRUcsS0FGSCxDQUVTLGFBQUs7QUFDWixhQUFPLEtBQVAsQ0FBYSxDQUFiLEVBRFk7QUFFWixVQUFJLE1BQUosQ0FBVyxH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O0FBRXhELFVBQUksSUFBSixDQUFTLElBQVQsRUFGd0Q7QUFHeEQseUJBQW1CLElBQW5CLEVBSHdEO0tBQVYsQ0FBaEQsQ0FJRyxLQUpILENBSVMsYUFBSztBQUNaLGFBQU8sS0FBUCxDQUFhLENBQWIsRUFEWTtBQUVaLFVBQUksTUFBSixDQUFXLEdBQVgsRUFBZ0IsR0FBaEIsR0FGWTtLQUFMLENBSlQsQ0FEeUI7R0FBekIsQ0FERixDQTNJdUI7O0FBdUp2QixTQUFPLE1BQVAsQ0FBYyxPQUFkLEVBQ0UsVUFBUyxHQUFULEVBQWMsR0FBZCxFQUFtQixJQUFuQixFQUF5QjtBQUN6QixTQUFLLE1BQUwsQ0FBWSxJQUFJLE1BQUosQ0FBVyxHQUFYLENBQVosQ0FBNEIsSUFBNUIsQ0FBaUMsWUFBTTtBQUNyQyxVQUFJLElBQUosQ0FBUyxDQUFDLElBQUksTUFBSixDQUFXLEdBQVgsQ0FBVixFQURxQztLQUFOLENBQWpDLENBRUcsS0FGSCxDQUVTLGFBQUs7QUFDWixhQUFPLEtBQVAsQ0FBYSxDQUFiLEVBRFk7QUFFWixVQUFJLE1BQUosQ0FBVyxHQUFYLEVBQWdCLEdBQWhCLEdBRlk7S0FBTCxDQUZULENBRHlCO0dBQXpCLENBREYsQ0F2SnVCOztBQWlLdkIsU0FBTyxNQUFQLENBakt1QjtDQUF6Qjs7QUFvS0EsT0FBTyxPQUFQLEdBQWlCLE9BQWpCIiwiZmlsZSI6InRyZWUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcbnZhciByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpO1xudmFyIGZzID0gcmVxdWlyZSgnYmx1ZWJpcmQnKS5wcm9taXNpZnlBbGwocmVxdWlyZSgnZnMtZXh0cmEnKSk7XG52YXIgcGF0aD1yZXF1aXJlKCdwYXRoJyk7XG52YXIgXz1yZXF1aXJlKCdsb2Rhc2gnKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCdsb2c0anMnKS5nZXRMb2dnZXIoJ3NlcnZlcicpO1xubG9nZ2VyLnNldExldmVsKCdERUJVRycpOyAvL+eoi+W6j+WujOaIkOWQjuazqOmHiuaOieOAguWPr+S7peWIh+aNouWbnum7mOiupOetiee6p++8jOWHj+WwkWxvZ1xuXG5mdW5jdGlvbiBmYWN0b3J5KGNvbmZpZykge1xuICB2YXIgdHJlZTtcbiAgaWYoY29uZmlnLm1vbmdvZGIpe1xuICAgIHRyZWUgPSByZXF1aXJlKCcuLi90cmVlLW1vbmdvZGInKShjb25maWcubW9uZ29kYik7XG4gIH1lbHNlIGlmKGNvbmZpZy5uZWRiKXtcbiAgICB0cmVlID0gcmVxdWlyZSgnLi4vdHJlZS1uZWRiJykoY29uZmlnLm5lZGIpO1xuICB9ZWxzZSBpZihjb25maWcubGVhbmNsb3VkKXtcbiAgICB0cmVlID0gcmVxdWlyZSgnLi4vdHJlZS1sZWFuY2xvdWQnKShjb25maWcubGVhbmNsb3VkKTtcbiAgfVxuXG4gIHJvdXRlci5wb3N0KCcvbm9kZXMnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIHRyZWUucmVhZF9ub2RlcyhyZXEuYm9keSkudGhlbihub2RlcyA9PiB7XG4gICAgICByZXMuanNvbihub2Rlcyk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgcm91dGVyLnBvc3QoJy9tay9zb24vOmdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKHJlcS5ib2R5KTtcblxuICAgIHRyZWUubWtfc29uX2J5X2RhdGEocmVxLnBhcmFtcy5naWQsIHJlcS5ib2R5KS50aGVuKG5vZGUgPT4ge1xuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xuICAgICAgcmVzLmpzb24obm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJvdXRlci5wb3N0KCcvbWsvc29uX25hbWUvOmdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgbG9nZ2VyLmRlYnVnKHJlcS5ib2R5KTtcblxuICAgIHRyZWUubWtfc29uX2J5X25hbWUocmVxLnBhcmFtcy5naWQsIHJlcS5ib2R5Lm5hbWUpLnRoZW4obm9kZSA9PiB7XG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XG4gICAgICByZXMuanNvbihub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cblxuICByb3V0ZXIucG9zdCgnL21rL2Jyb3RoZXIvOmJnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIC8vIHJlcy5zZW5kKCdtayBicm90aGVyIG9mJytyZXEucGFyYW1zLmJnaWQpO1xuICAgIHRyZWUubWtfYnJvdGhlcl9ieV9kYXRhKHJlcS5ib2R5LHJlcS5wYXJhbXMuYmdpZCkudGhlbigobm9kZSkgPT4ge1xuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xuICAgICAgcmVzLmpzb24obm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgcm91dGVyLnBvc3QoJy9tdi86c2dpZC9zb24vOmRnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIHZhciBwID0gcmVxLnBhcmFtcztcbiAgICAvLyBsb2dnZXIuZGVidWcoYG12ICR7cC5zZ2lkfSBhcyBzb24gb2YgJHtwLmRnaWR9YCk7XG4gICAgdHJlZS5tb3ZlX2FzX3NvbihwLnNnaWQscC5kZ2lkKS50aGVuKG5vZGUgPT4ge1xuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xuICAgICAgcmVzLmpzb24obm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJvdXRlci5wb3N0KCcvbXYvOnNnaWQvYnJvdGhlci86ZGdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdmFyIHAgPSByZXEucGFyYW1zO1xuICAgIC8vIGxvZ2dlci5kZWJ1ZyhgbXYgJHtwLnNnaWR9IGFzIGJyb3RoZXIgb2YgJHtwLmRnaWR9YCk7XG4gICAgdHJlZS5tb3ZlX2FzX2Jyb3RoZXIocC5zZ2lkLHAuZGdpZCkudGhlbihub2RlID0+IHtcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuXG4gIGZ1bmN0aW9uIGNsb25lKG9iail7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShvYmopKTtcbiAgfVxuICBcbiAgZnVuY3Rpb24gZXhwYW5kKG5vZGUsbGV2ZWwpeyAvL2xldmVs55So5LqO5o6n5Yi25bGV5byA55qE5bGC57qnXG4gICAgaWYobm9kZS5fbGluay5jaGlsZHJlbi5sZW5ndGg9PTAgfHwgbGV2ZWw8PTAgKXsgLy/kuI3lgZrlsZXlvIDnmoQy56eN5oOF5Ya144CCMS7msqHmnInlrZDoioLngrnjgIIy77yM5bGV5byA5bGC57qn5bCP5LqOMFxuICAgICAgICB2YXIgY2xvbmVOb2RlPWNsb25lKG5vZGUpO1xuICAgICAgICBjbG9uZU5vZGUuX2NoaWxkcmVuPVtdO1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNsb25lTm9kZSk7XG4gICAgfWVsc2V7XG4gICAgICAgIHJldHVybiB0cmVlLnJlYWRfbm9kZXMobm9kZS5fbGluay5jaGlsZHJlbilcbiAgICAgICAgLnRoZW4obm9kZXM9PntcbiAgICAgICAgICBsb2dnZXIuZGVidWcoJ2NoaWxkcmVuOicsbm9kZS5fbGluay5jaGlsZHJlbiwnbm9kZXMnLG5vZGVzKVxuICAgICAgICAgICAgY29uc3QgZm5vZGVzPW5vZGVzLm1hcChub2RlPT5leHBhbmQobm9kZSxsZXZlbC0xKSk7XG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZm5vZGVzKS50aGVuKG5vZGVzPT57XG4gICAgICAgICAgICAgICAgdmFyIGNsb25lTm9kZT1jbG9uZShub2RlKTtcbiAgICAgICAgICAgICAgICBjbG9uZU5vZGUuX2NoaWxkcmVuPW5vZGVzfHxbXTsgLy/lsZXlvIDnmoToioLngrnmlL7liLBfY2hpbGRyZW7kuK1cbiAgICAgICAgICAgICAgICByZXR1cm4gY2xvbmVOb2RlO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiByZWFkX2JpZ25vZGUoZ2lkLGxldmVsKSB7XG4gICAgcmV0dXJuIHRyZWUucmVhZF9ub2RlKGdpZCkudGhlbihcbiAgICAgIG5vZGU9PmV4cGFuZChub2RlLGxldmVsKVxuICAgICk7IFxuICB9XG5cbiAgLyogR0VUIGFwaSAuICovXG4gIHJvdXRlci5nZXQoJy86Z2lkJyxcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIHRyZWUucmVhZF9ub2RlKHJlcS5wYXJhbXMuZ2lkKS50aGVuKG5vZGU9PiB7ICAgIFxuICAgICAgcmV0dXJuIHJlcy5qc29uKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICAgIC8qIEdFVCBleHBhbmRlZCBub2RlICAuICovXG4gIHJvdXRlci5nZXQoJy9iaWdub2RlLzpnaWQvOmxldmVsJyxcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgICAgcmVhZF9iaWdub2RlKHJlcS5wYXJhbXMuZ2lkLHJlcS5wYXJhbXMubGV2ZWwpLnRoZW4obm9kZT0+IHsgICAgXG4gICAgICAgIHJldHVybiByZXMuanNvbihub2RlKTtcbiAgICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICAgIH0pO1xuICB9KTtcblxuICByb3V0ZXIucHV0KCcvOmdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdHJlZS51cGRhdGVfZGF0YShyZXEucGFyYW1zLmdpZCwgcmVxLmJvZHkpLnRoZW4oKG5vZGUpID0+IHtcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xuICAgICAgc2F2ZTJlbGFzdGljc2VhcmNoKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICByb3V0ZXIuZGVsZXRlKCcvOmdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdHJlZS5yZW1vdmUocmVxLnBhcmFtcy5naWQpLnRoZW4oKCkgPT4ge1xuICAgICAgcmVzLmpzb24oW3JlcS5wYXJhbXMuZ2lkXSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJldHVybiByb3V0ZXI7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gZmFjdG9yeTsiXX0=