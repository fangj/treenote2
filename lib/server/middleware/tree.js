'use strict';

var express = require('express');
var router = express.Router();
var fs = require('bluebird').promisifyAll(require('fs-extra'));
var path = require('path');
var _ = require('lodash');
var logger = require('log4js').getLogger('server');
logger.setLevel('DEBUG'); //程序完成后注释掉。可以切换回默认等级，减少log

function factory(config) {
  var tree;
  if (config.mongodb) {
    tree = require('../tree-mongodb')(config.mongodb);
  } else if (config.nedb) {
    tree = require('../tree-nedb')(config.nedb);
  } else if (config.leancloud) {
    tree = require('../tree-leancloud')(config.leancloud);
  }

  router.post('/nodes', function (req, res, next) {
    tree.read_nodes(req.body).then(function (nodes) {
      res.json(nodes);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son/:gid', function (req, res, next) {
    // logger.debug(req.body);

    tree.mk_son_by_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son_name/:gid', function (req, res, next) {
    // logger.debug(req.body);

    tree.mk_son_by_name(req.params.gid, req.body.name).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/brother/:bgid', function (req, res, next) {
    // res.send('mk brother of'+req.params.bgid);
    tree.mk_brother_by_data(req.body, req.params.bgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/son/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as son of ${p.dgid}`);
    tree.move_as_son(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/brother/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as brother of ${p.dgid}`);
    tree.move_as_brother(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function expand(node, level) {
    //level用于控制展开的层级
    if (node._link.children.length == 0 || level <= 0) {
      //不做展开的2种情况。1.没有子节点。2，展开层级小于0
      var cloneNode = clone(node);
      cloneNode._children = [];
      return Promise.resolve(cloneNode);
    } else {
      return tree.read_nodes(node._link.children).then(function (nodes) {
        // logger.debug('children:',node._link.children,'nodes',nodes)
        var fnodes = nodes.map(function (node) {
          return expand(node, level - 1);
        });
        return Promise.all(fnodes).then(function (nodes) {
          var cloneNode = clone(node);
          cloneNode._children = nodes || []; //展开的节点放到_children中
          return cloneNode;
        });
      });
    }
  }

  function read_bignode(gid, level) {
    return tree.read_node(gid).then(function (node) {
      return expand(node, level);
    });
  }

  /* GET api . */
  router.get('/:gid', function (req, res, next) {
    tree.read_node(req.params.gid).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  /* GET expanded node  . */
  router.get('/bignode/:gid/:level', function (req, res, next) {
    read_bignode(req.params.gid, req.params.level).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.put('/:gid', function (req, res, next) {
    tree.update_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
      save2elasticsearch(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.delete('/:gid', function (req, res, next) {
    tree.remove(req.params.gid).then(function () {
      res.json([req.params.gid]);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  return router;
}

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvbWlkZGxld2FyZS90cmVlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxVQUFVLFFBQVEsU0FBUixDQUFWO0FBQ0osSUFBSSxTQUFTLFFBQVEsTUFBUixFQUFUO0FBQ0osSUFBSSxLQUFLLFFBQVEsVUFBUixFQUFvQixZQUFwQixDQUFpQyxRQUFRLFVBQVIsQ0FBakMsQ0FBTDtBQUNKLElBQUksT0FBSyxRQUFRLE1BQVIsQ0FBTDtBQUNKLElBQUksSUFBRSxRQUFRLFFBQVIsQ0FBRjtBQUNKLElBQUksU0FBUyxRQUFRLFFBQVIsRUFBa0IsU0FBbEIsQ0FBNEIsUUFBNUIsQ0FBVDtBQUNKLE9BQU8sUUFBUCxDQUFnQixPQUFoQjs7QUFFQSxTQUFTLE9BQVQsQ0FBaUIsTUFBakIsRUFBeUI7QUFDdkIsTUFBSSxJQUFKLENBRHVCO0FBRXZCLE1BQUcsT0FBTyxPQUFQLEVBQWU7QUFDaEIsV0FBTyxRQUFRLGlCQUFSLEVBQTJCLE9BQU8sT0FBUCxDQUFsQyxDQURnQjtHQUFsQixNQUVNLElBQUcsT0FBTyxJQUFQLEVBQVk7QUFDbkIsV0FBTyxRQUFRLGNBQVIsRUFBd0IsT0FBTyxJQUFQLENBQS9CLENBRG1CO0dBQWYsTUFFQSxJQUFHLE9BQU8sU0FBUCxFQUFpQjtBQUN4QixXQUFPLFFBQVEsbUJBQVIsRUFBNkIsT0FBTyxTQUFQLENBQXBDLENBRHdCO0dBQXBCOztBQUlOLFNBQU8sSUFBUCxDQUFZLFFBQVosRUFDRSxVQUFTLEdBQVQsRUFBYyxHQUFkLEVBQW1CLElBQW5CLEVBQXlCO0FBQ3pCLFNBQUssVUFBTCxDQUFnQixJQUFJLElBQUosQ0FBaEIsQ0FBMEIsSUFBMUIsQ0FBK0IsaUJBQVM7QUFDdEMsVUFBSSxJQUFKLENBQVMsS0FBVCxFQURzQztLQUFULENBQS9CLENBRUcsS0FGSCxDQUVTLGFBQUs7QUFDWixhQUFPLEtBQVAsQ0FBYSxDQUFiLEVBRFk7QUFFWixVQUFJLE1BQUosQ0FBVyxH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S0FBTCxDQUpULENBRHlCO0dBQXpCLENBREYsQ0EzSXVCOztBQXVKdkIsU0FBTyxNQUFQLENBQWMsT0FBZCxFQUNFLFVBQVMsR0FBVCxFQUFjLEdBQWQsRUFBbUIsSUFBbkIsRUFBeUI7QUFDekIsU0FBSyxNQUFMLENBQVksSUFBSSxNQUFKLENBQVcsR0FBWCxDQUFaLENBQTRCLElBQTVCLENBQWlDLFlBQU07QUFDckMsVUFBSSxJQUFKLENBQVMsQ0FBQyxJQUFJLE1BQUosQ0FBVyxHQUFYLENBQVYsRUFEcUM7S0FBTixDQUFqQyxDQUVHLEtBRkgsQ0FFUyxhQUFLO0FBQ1osYUFBTyxLQUFQLENBQWEsQ0FBYixFQURZO0FBRVosVUFBSSxNQUFKLENBQVcsR0FBWCxFQUFnQixHQUFoQixHQUZZO0tBQUwsQ0FGVCxDQUR5QjtHQUF6QixDQURGLENBdkp1Qjs7QUFpS3ZCLFNBQU8sTUFBUCxDQWpLdUI7Q0FBekI7O0FBb0tBLE9BQU8sT0FBUCxHQUFpQixPQUFqQiIsImZpbGUiOiJ0cmVlLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG52YXIgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbnZhciBmcyA9IHJlcXVpcmUoJ2JsdWViaXJkJykucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ2ZzLWV4dHJhJykpO1xudmFyIHBhdGg9cmVxdWlyZSgncGF0aCcpO1xudmFyIF89cmVxdWlyZSgnbG9kYXNoJyk7XG52YXIgbG9nZ2VyID0gcmVxdWlyZSgnbG9nNGpzJykuZ2V0TG9nZ2VyKCdzZXJ2ZXInKTtcbmxvZ2dlci5zZXRMZXZlbCgnREVCVUcnKTsgLy/nqIvluo/lrozmiJDlkI7ms6jph4rmjonjgILlj6/ku6XliIfmjaLlm57pu5jorqTnrYnnuqfvvIzlh4/lsJFsb2dcblxuZnVuY3Rpb24gZmFjdG9yeShjb25maWcpIHtcbiAgdmFyIHRyZWU7XG4gIGlmKGNvbmZpZy5tb25nb2RiKXtcbiAgICB0cmVlID0gcmVxdWlyZSgnLi4vdHJlZS1tb25nb2RiJykoY29uZmlnLm1vbmdvZGIpO1xuICB9ZWxzZSBpZihjb25maWcubmVkYil7XG4gICAgdHJlZSA9IHJlcXVpcmUoJy4uL3RyZWUtbmVkYicpKGNvbmZpZy5uZWRiKTtcbiAgfWVsc2UgaWYoY29uZmlnLmxlYW5jbG91ZCl7XG4gICAgdHJlZSA9IHJlcXVpcmUoJy4uL3RyZWUtbGVhbmNsb3VkJykoY29uZmlnLmxlYW5jbG91ZCk7XG4gIH1cblxuICByb3V0ZXIucG9zdCgnL25vZGVzJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICB0cmVlLnJlYWRfbm9kZXMocmVxLmJvZHkpLnRoZW4obm9kZXMgPT4ge1xuICAgICAgcmVzLmpzb24obm9kZXMpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuXG4gIHJvdXRlci5wb3N0KCcvbWsvc29uLzpnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIC8vIGxvZ2dlci5kZWJ1ZyhyZXEuYm9keSk7XG5cbiAgICB0cmVlLm1rX3Nvbl9ieV9kYXRhKHJlcS5wYXJhbXMuZ2lkLCByZXEuYm9keSkudGhlbihub2RlID0+IHtcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICByb3V0ZXIucG9zdCgnL21rL3Nvbl9uYW1lLzpnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIC8vIGxvZ2dlci5kZWJ1ZyhyZXEuYm9keSk7XG5cbiAgICB0cmVlLm1rX3Nvbl9ieV9uYW1lKHJlcS5wYXJhbXMuZ2lkLCByZXEuYm9keS5uYW1lKS50aGVuKG5vZGUgPT4ge1xuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xuICAgICAgcmVzLmpzb24obm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgcm91dGVyLnBvc3QoJy9tay9icm90aGVyLzpiZ2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICAvLyByZXMuc2VuZCgnbWsgYnJvdGhlciBvZicrcmVxLnBhcmFtcy5iZ2lkKTtcbiAgICB0cmVlLm1rX2Jyb3RoZXJfYnlfZGF0YShyZXEuYm9keSxyZXEucGFyYW1zLmJnaWQpLnRoZW4oKG5vZGUpID0+IHtcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuXG4gIHJvdXRlci5wb3N0KCcvbXYvOnNnaWQvc29uLzpkZ2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICB2YXIgcCA9IHJlcS5wYXJhbXM7XG4gICAgLy8gbG9nZ2VyLmRlYnVnKGBtdiAke3Auc2dpZH0gYXMgc29uIG9mICR7cC5kZ2lkfWApO1xuICAgIHRyZWUubW92ZV9hc19zb24ocC5zZ2lkLHAuZGdpZCkudGhlbihub2RlID0+IHtcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICByb3V0ZXIucG9zdCgnL212LzpzZ2lkL2Jyb3RoZXIvOmRnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIHZhciBwID0gcmVxLnBhcmFtcztcbiAgICAvLyBsb2dnZXIuZGVidWcoYG12ICR7cC5zZ2lkfSBhcyBicm90aGVyIG9mICR7cC5kZ2lkfWApO1xuICAgIHRyZWUubW92ZV9hc19icm90aGVyKHAuc2dpZCxwLmRnaWQpLnRoZW4obm9kZSA9PiB7XG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XG4gICAgICByZXMuanNvbihub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cblxuICBmdW5jdGlvbiBjbG9uZShvYmope1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7XG4gIH1cbiAgXG4gIGZ1bmN0aW9uIGV4cGFuZChub2RlLGxldmVsKXsgLy9sZXZlbOeUqOS6juaOp+WItuWxleW8gOeahOWxgue6p1xuICAgIGlmKG5vZGUuX2xpbmsuY2hpbGRyZW4ubGVuZ3RoPT0wIHx8IGxldmVsPD0wICl7IC8v5LiN5YGa5bGV5byA55qEMuenjeaDheWGteOAgjEu5rKh5pyJ5a2Q6IqC54K544CCMu+8jOWxleW8gOWxgue6p+Wwj+S6jjBcbiAgICAgICAgdmFyIGNsb25lTm9kZT1jbG9uZShub2RlKTtcbiAgICAgICAgY2xvbmVOb2RlLl9jaGlsZHJlbj1bXTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjbG9uZU5vZGUpO1xuICAgIH1lbHNle1xuICAgICAgICByZXR1cm4gdHJlZS5yZWFkX25vZGVzKG5vZGUuX2xpbmsuY2hpbGRyZW4pXG4gICAgICAgIC50aGVuKG5vZGVzPT57XG4gICAgICAgICAgLy8gbG9nZ2VyLmRlYnVnKCdjaGlsZHJlbjonLG5vZGUuX2xpbmsuY2hpbGRyZW4sJ25vZGVzJyxub2RlcylcbiAgICAgICAgICAgIGNvbnN0IGZub2Rlcz1ub2Rlcy5tYXAobm9kZT0+ZXhwYW5kKG5vZGUsbGV2ZWwtMSkpO1xuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGZub2RlcykudGhlbihub2Rlcz0+e1xuICAgICAgICAgICAgICAgIHZhciBjbG9uZU5vZGU9Y2xvbmUobm9kZSk7XG4gICAgICAgICAgICAgICAgY2xvbmVOb2RlLl9jaGlsZHJlbj1ub2Rlc3x8W107IC8v5bGV5byA55qE6IqC54K55pS+5YiwX2NoaWxkcmVu5LitXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsb25lTm9kZTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gcmVhZF9iaWdub2RlKGdpZCxsZXZlbCkge1xuICAgIHJldHVybiB0cmVlLnJlYWRfbm9kZShnaWQpLnRoZW4oXG4gICAgICBub2RlPT5leHBhbmQobm9kZSxsZXZlbClcbiAgICApOyBcbiAgfVxuXG4gIC8qIEdFVCBhcGkgLiAqL1xuICByb3V0ZXIuZ2V0KCcvOmdpZCcsXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICB0cmVlLnJlYWRfbm9kZShyZXEucGFyYW1zLmdpZCkudGhlbihub2RlPT4geyAgICBcbiAgICAgIHJldHVybiByZXMuanNvbihub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgICAvKiBHRVQgZXhwYW5kZWQgbm9kZSAgLiAqL1xuICByb3V0ZXIuZ2V0KCcvYmlnbm9kZS86Z2lkLzpsZXZlbCcsXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICAgIHJlYWRfYmlnbm9kZShyZXEucGFyYW1zLmdpZCxyZXEucGFyYW1zLmxldmVsKS50aGVuKG5vZGU9PiB7ICAgIFxuICAgICAgICByZXR1cm4gcmVzLmpzb24obm9kZSk7XG4gICAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgICB9KTtcbiAgfSk7XG5cbiAgcm91dGVyLnB1dCgnLzpnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIHRyZWUudXBkYXRlX2RhdGEocmVxLnBhcmFtcy5naWQsIHJlcS5ib2R5KS50aGVuKChub2RlKSA9PiB7XG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XG4gICAgICByZXMuanNvbihub2RlKTtcbiAgICAgIHNhdmUyZWxhc3RpY3NlYXJjaChub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcm91dGVyLmRlbGV0ZSgnLzpnaWQnLCBcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xuICAgIHRyZWUucmVtb3ZlKHJlcS5wYXJhbXMuZ2lkKS50aGVuKCgpID0+IHtcbiAgICAgIHJlcy5qc29uKFtyZXEucGFyYW1zLmdpZF0pO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICByZXR1cm4gcm91dGVyO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGZhY3Rvcnk7Il19