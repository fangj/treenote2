'use strict';

var express = require('express');
var router = express.Router();
var fs = require('bluebird').promisifyAll(require('fs-extra'));
var path = require('path');
var _ = require('lodash');
var logger = require('log4js').getLogger('server');
logger.setLevel('DEBUG'); //程序完成后注释掉。可以切换回默认等级，减少log

function factory(config) {

  var tree = require('../tree-nedb')(config.nedb);

  router.post('/nodes', function (req, res, next) {
    tree.read_nodes(req.body).then(function (nodes) {
      res.json(nodes);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son/:gid', function (req, res, next) {
    logger.debug(req.body);

    tree.mk_son_by_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son_name/:gid', function (req, res, next) {
    logger.debug(req.body);

    tree.mk_son_by_name(req.params.gid, req.body.name).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/brother/:bgid', function (req, res, next) {
    // res.send('mk brother of'+req.params.bgid);
    tree.mk_brother_by_data(req.body, req.params.bgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/son/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as son of ${p.dgid}`);
    tree.move_as_son(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/brother/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as brother of ${p.dgid}`);
    tree.move_as_brother(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function expand(node, level) {
    //level用于控制展开的层级
    if (node._link.children.length == 0 || level <= 0) {
      //不做展开的2种情况。1.没有子节点。2，展开层级小于0
      var cloneNode = clone(node);
      cloneNode._children = [];
      return Promise.resolve(cloneNode);
    } else {
      return tree.read_nodes(node._link.children).then(function (nodes) {
        logger.debug('children:', node._link.children, 'nodes', nodes);
        var fnodes = nodes.map(function (node) {
          return expand(node, level - 1);
        });
        return Promise.all(fnodes).then(function (nodes) {
          var cloneNode = clone(node);
          cloneNode._children = nodes || []; //展开的节点放到_children中
          return cloneNode;
        });
      });
    }
  }

  function read_bignode(gid, level) {
    return tree.read_node(gid).then(function (node) {
      return expand(node, level);
    });
  }

  /* GET api . */
  router.get('/:gid', function (req, res, next) {
    tree.read_node(req.params.gid).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  /* GET expanded node  . */
  router.get('/bignode/:gid/:level', function (req, res, next) {
    read_bignode(req.params.gid, req.params.level).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.put('/:gid', function (req, res, next) {
    tree.update_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
      save2elasticsearch(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.delete('/:gid', function (req, res, next) {
    tree.remove(req.params.gid).then(function () {
      res.json([req.params.gid]);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  return router;
}

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvbWlkZGxld2FyZS90cmVlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxVQUFVLFFBQVEsU0FBUixDQUFkO0FBQ0EsSUFBSSxTQUFTLFFBQVEsTUFBUixFQUFiO0FBQ0EsSUFBSSxLQUFLLFFBQVEsVUFBUixFQUFvQixZQUFwQixDQUFpQyxRQUFRLFVBQVIsQ0FBakMsQ0FBVDtBQUNBLElBQUksT0FBSyxRQUFRLE1BQVIsQ0FBVDtBQUNBLElBQUksSUFBRSxRQUFRLFFBQVIsQ0FBTjtBQUNBLElBQUksU0FBUyxRQUFRLFFBQVIsRUFBa0IsU0FBbEIsQ0FBNEIsUUFBNUIsQ0FBYjtBQUNBLE9BQU8sUUFBUCxDQUFnQixPQUFoQixFLENBQTBCOztBQUUxQixTQUFTLE9BQVQsQ0FBaUIsTUFBakIsRUFBeUI7O0FBRXZCLE1BQUksT0FBTyxRQUFRLGNBQVIsRUFBd0IsT0FBTyxJQUEvQixDQUFYOztBQUVBLFNBQU8sSUFBUCxDQUFZLFFBQVosRUFDRSxVQUFTLEdBQVQsRUFBYyxHQUFkLEVBQW1CLElBQW5CLEVBQXlCO0FBQ3pCLFNBQUssVUFBTCxDQUFnQixJQUFJLElBQXBCLEVBQTBCLElBQTFCLENBQStCLGlCQUFTO0FBQ3RDLFVBQUksSUFBSixDQUFTLEtBQVQ7QUFDRCxLQUZELEVBRUcsS0FGSCxDQUVTLGFBQUs7QUFDWixhQUFPLEtBQVAsQ0FBYSxDQUFiO0FBQ0EsVUFBSSxNQUFKLENBQVcsR0FBWCxFQUFnQixHQUFoQjtBQUNELEtBTEQ7QUFNRCxHQVJEOztBQVdBLFNBQU8sSUFBUCxDQUFZLGNBQVosRUFDRSxVQUFTLEdBQVQsRUFBYyxHQUFkLEVBQW1CLElBQW5CLEVBQXlCO0FBQ3pCLFdBQU8sS0FBUCxDQUFhLElBQUksSUFBakI7O0FBRUEsU0FBSyxjQUFMLENBQW9CLElBQUksTUFBSixDQUFXLEdBQS9CLEVBQW9DLElBQUksSUFBeEMsRUFBOEMsSUFBOUMsQ0FBbUQsZ0JBQVE7QUFD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InRyZWUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTtcclxudmFyIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcbnZhciBmcyA9IHJlcXVpcmUoJ2JsdWViaXJkJykucHJvbWlzaWZ5QWxsKHJlcXVpcmUoJ2ZzLWV4dHJhJykpO1xyXG52YXIgcGF0aD1yZXF1aXJlKCdwYXRoJyk7XHJcbnZhciBfPXJlcXVpcmUoJ2xvZGFzaCcpO1xyXG52YXIgbG9nZ2VyID0gcmVxdWlyZSgnbG9nNGpzJykuZ2V0TG9nZ2VyKCdzZXJ2ZXInKTtcclxubG9nZ2VyLnNldExldmVsKCdERUJVRycpOyAvL+eoi+W6j+WujOaIkOWQjuazqOmHiuaOieOAguWPr+S7peWIh+aNouWbnum7mOiupOetiee6p++8jOWHj+WwkWxvZ1xyXG5cclxuZnVuY3Rpb24gZmFjdG9yeShjb25maWcpIHtcclxuXHJcbiAgdmFyIHRyZWUgPSByZXF1aXJlKCcuLi90cmVlLW5lZGInKShjb25maWcubmVkYik7XHJcblxyXG4gIHJvdXRlci5wb3N0KCcvbm9kZXMnLCBcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICB0cmVlLnJlYWRfbm9kZXMocmVxLmJvZHkpLnRoZW4obm9kZXMgPT4ge1xyXG4gICAgICByZXMuanNvbihub2Rlcyk7XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcblxyXG4gIHJvdXRlci5wb3N0KCcvbWsvc29uLzpnaWQnLCBcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICBsb2dnZXIuZGVidWcocmVxLmJvZHkpO1xyXG5cclxuICAgIHRyZWUubWtfc29uX2J5X2RhdGEocmVxLnBhcmFtcy5naWQsIHJlcS5ib2R5KS50aGVuKG5vZGUgPT4ge1xyXG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XHJcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIHJvdXRlci5wb3N0KCcvbWsvc29uX25hbWUvOmdpZCcsIFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIGxvZ2dlci5kZWJ1ZyhyZXEuYm9keSk7XHJcblxyXG4gICAgdHJlZS5ta19zb25fYnlfbmFtZShyZXEucGFyYW1zLmdpZCwgcmVxLmJvZHkubmFtZSkudGhlbihub2RlID0+IHtcclxuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xyXG4gICAgICByZXMuanNvbihub2RlKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuXHJcbiAgcm91dGVyLnBvc3QoJy9tay9icm90aGVyLzpiZ2lkJywgXHJcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgLy8gcmVzLnNlbmQoJ21rIGJyb3RoZXIgb2YnK3JlcS5wYXJhbXMuYmdpZCk7XHJcbiAgICB0cmVlLm1rX2Jyb3RoZXJfYnlfZGF0YShyZXEuYm9keSxyZXEucGFyYW1zLmJnaWQpLnRoZW4oKG5vZGUpID0+IHtcclxuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xyXG4gICAgICByZXMuanNvbihub2RlKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuXHJcbiAgcm91dGVyLnBvc3QoJy9tdi86c2dpZC9zb24vOmRnaWQnLCBcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICB2YXIgcCA9IHJlcS5wYXJhbXM7XHJcbiAgICAvLyBsb2dnZXIuZGVidWcoYG12ICR7cC5zZ2lkfSBhcyBzb24gb2YgJHtwLmRnaWR9YCk7XHJcbiAgICB0cmVlLm1vdmVfYXNfc29uKHAuc2dpZCxwLmRnaWQpLnRoZW4obm9kZSA9PiB7XHJcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcclxuICAgICAgcmVzLmpzb24obm9kZSk7XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgcm91dGVyLnBvc3QoJy9tdi86c2dpZC9icm90aGVyLzpkZ2lkJywgXHJcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgdmFyIHAgPSByZXEucGFyYW1zO1xyXG4gICAgLy8gbG9nZ2VyLmRlYnVnKGBtdiAke3Auc2dpZH0gYXMgYnJvdGhlciBvZiAke3AuZGdpZH1gKTtcclxuICAgIHRyZWUubW92ZV9hc19icm90aGVyKHAuc2dpZCxwLmRnaWQpLnRoZW4obm9kZSA9PiB7XHJcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcclxuICAgICAgcmVzLmpzb24obm9kZSk7XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcblxyXG4gIGZ1bmN0aW9uIGNsb25lKG9iail7XHJcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpO1xyXG4gIH1cclxuICBcclxuICBmdW5jdGlvbiBleHBhbmQobm9kZSxsZXZlbCl7IC8vbGV2ZWznlKjkuo7mjqfliLblsZXlvIDnmoTlsYLnuqdcclxuICAgIGlmKG5vZGUuX2xpbmsuY2hpbGRyZW4ubGVuZ3RoPT0wIHx8IGxldmVsPD0wICl7IC8v5LiN5YGa5bGV5byA55qEMuenjeaDheWGteOAgjEu5rKh5pyJ5a2Q6IqC54K544CCMu+8jOWxleW8gOWxgue6p+Wwj+S6jjBcclxuICAgICAgICB2YXIgY2xvbmVOb2RlPWNsb25lKG5vZGUpO1xyXG4gICAgICAgIGNsb25lTm9kZS5fY2hpbGRyZW49W107XHJcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShjbG9uZU5vZGUpO1xyXG4gICAgfWVsc2V7XHJcbiAgICAgICAgcmV0dXJuIHRyZWUucmVhZF9ub2Rlcyhub2RlLl9saW5rLmNoaWxkcmVuKVxyXG4gICAgICAgIC50aGVuKG5vZGVzPT57XHJcbiAgICAgICAgICBsb2dnZXIuZGVidWcoJ2NoaWxkcmVuOicsbm9kZS5fbGluay5jaGlsZHJlbiwnbm9kZXMnLG5vZGVzKVxyXG4gICAgICAgICAgICBjb25zdCBmbm9kZXM9bm9kZXMubWFwKG5vZGU9PmV4cGFuZChub2RlLGxldmVsLTEpKTtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKGZub2RlcykudGhlbihub2Rlcz0+e1xyXG4gICAgICAgICAgICAgICAgdmFyIGNsb25lTm9kZT1jbG9uZShub2RlKTtcclxuICAgICAgICAgICAgICAgIGNsb25lTm9kZS5fY2hpbGRyZW49bm9kZXN8fFtdOyAvL+WxleW8gOeahOiKgueCueaUvuWIsF9jaGlsZHJlbuS4rVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsb25lTm9kZTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gcmVhZF9iaWdub2RlKGdpZCxsZXZlbCkge1xyXG4gICAgcmV0dXJuIHRyZWUucmVhZF9ub2RlKGdpZCkudGhlbihcclxuICAgICAgbm9kZT0+ZXhwYW5kKG5vZGUsbGV2ZWwpXHJcbiAgICApOyBcclxuICB9XHJcblxyXG4gIC8qIEdFVCBhcGkgLiAqL1xyXG4gIHJvdXRlci5nZXQoJy86Z2lkJyxcclxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XHJcbiAgICB0cmVlLnJlYWRfbm9kZShyZXEucGFyYW1zLmdpZCkudGhlbihub2RlPT4geyAgICBcclxuICAgICAgcmV0dXJuIHJlcy5qc29uKG5vZGUpO1xyXG4gICAgfSkuY2F0Y2goZSA9PiB7XHJcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gICAgLyogR0VUIGV4cGFuZGVkIG5vZGUgIC4gKi9cclxuICByb3V0ZXIuZ2V0KCcvYmlnbm9kZS86Z2lkLzpsZXZlbCcsXHJcbiAgICBmdW5jdGlvbihyZXEsIHJlcywgbmV4dCkge1xyXG4gICAgICByZWFkX2JpZ25vZGUocmVxLnBhcmFtcy5naWQscmVxLnBhcmFtcy5sZXZlbCkudGhlbihub2RlPT4geyAgICBcclxuICAgICAgICByZXR1cm4gcmVzLmpzb24obm9kZSk7XHJcbiAgICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICAgIGxvZ2dlci5lcnJvcihlKTtcclxuICAgICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICByb3V0ZXIucHV0KCcvOmdpZCcsIFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHRyZWUudXBkYXRlX2RhdGEocmVxLnBhcmFtcy5naWQsIHJlcS5ib2R5KS50aGVuKChub2RlKSA9PiB7XHJcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcclxuICAgICAgcmVzLmpzb24obm9kZSk7XHJcbiAgICAgIHNhdmUyZWxhc3RpY3NlYXJjaChub2RlKTtcclxuICAgIH0pLmNhdGNoKGUgPT4ge1xyXG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XHJcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICByb3V0ZXIuZGVsZXRlKCcvOmdpZCcsIFxyXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcclxuICAgIHRyZWUucmVtb3ZlKHJlcS5wYXJhbXMuZ2lkKS50aGVuKCgpID0+IHtcclxuICAgICAgcmVzLmpzb24oW3JlcS5wYXJhbXMuZ2lkXSk7XHJcbiAgICB9KS5jYXRjaChlID0+IHtcclxuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xyXG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgcmV0dXJuIHJvdXRlcjtcclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5OyJdfQ==