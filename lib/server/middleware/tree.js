'use strict';

var express = require('express');
var router = express.Router();
var fs = require('bluebird').promisifyAll(require('fs-extra'));
var path = require('path');
var _ = require('lodash');
var logger = require('log4js').getLogger('server');
logger.setLevel('DEBUG'); //程序完成后注释掉。可以切换回默认等级，减少log

function factory(config) {

  var tree = require('../tree-nedb')(config.nedb);

  router.post('/nodes', function (req, res, next) {
    tree.read_nodes(req.body).then(function (nodes) {
      res.json(nodes);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son/:gid', function (req, res, next) {
    logger.debug(req.body);

    tree.mk_son_by_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/son_name/:gid', function (req, res, next) {
    logger.debug(req.body);

    tree.mk_son_by_name(req.params.gid, req.body.name).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mk/brother/:bgid', function (req, res, next) {
    // res.send('mk brother of'+req.params.bgid);
    tree.mk_brother_by_data(req.body, req.params.bgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/son/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as son of ${p.dgid}`);
    tree.move_as_son(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.post('/mv/:sgid/brother/:dgid', function (req, res, next) {
    var p = req.params;
    // logger.debug(`mv ${p.sgid} as brother of ${p.dgid}`);
    tree.move_as_brother(p.sgid, p.dgid).then(function (node) {
      // logger.debug(node);
      res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  function clone(obj) {
    return JSON.parse(JSON.stringify(obj));
  }

  function expand(node, level) {
    //level用于控制展开的层级
    if (node._link.children.length == 0 || level <= 0) {
      //不做展开的2种情况。1.没有子节点。2，展开层级小于0
      var cloneNode = clone(node);
      cloneNode._children = [];
      return Promise.resolve(cloneNode);
    } else {
      return tree.read_nodes(node._link.children).then(function (nodes) {
        logger.debug('children:', node._link.children, 'nodes', nodes);
        var fnodes = nodes.map(function (node) {
          return expand(node, level - 1);
        });
        return Promise.all(fnodes).then(function (nodes) {
          var cloneNode = clone(node);
          cloneNode._children = nodes || []; //展开的节点放到_children中
          return cloneNode;
        });
      });
    }
  }

  function read_bignode(gid, level) {
    return tree.read_node(gid).then(function (node) {
      return expand(node, level);
    });
  }

  /* GET api . */
  router.get('/:gid', function (req, res, next) {
    tree.read_node(req.params.gid).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  /* GET expanded node  . */
  router.get('/bignode/:gid/:level', function (req, res, next) {
    read_bignode(req.params.gid, req.params.level).then(function (node) {
      return res.json(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.put('/:gid', function (req, res, next) {
    tree.update_data(req.params.gid, req.body).then(function (node) {
      // logger.debug(node);
      res.json(node);
      save2elasticsearch(node);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  router.delete('/:gid', function (req, res, next) {
    tree.remove(req.params.gid).then(function () {
      res.json([req.params.gid]);
    }).catch(function (e) {
      logger.error(e);
      res.status(500).end();
    });
  });

  return router;
}

module.exports = factory;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXJ2ZXIvbWlkZGxld2FyZS90cmVlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxVQUFVLFFBQVEsU0FBUixDQUFWO0FBQ0osSUFBSSxTQUFTLFFBQVEsTUFBUixFQUFUO0FBQ0osSUFBSSxLQUFLLFFBQVEsVUFBUixFQUFvQixZQUFwQixDQUFpQyxRQUFRLFVBQVIsQ0FBakMsQ0FBTDtBQUNKLElBQUksT0FBSyxRQUFRLE1BQVIsQ0FBTDtBQUNKLElBQUksSUFBRSxRQUFRLFFBQVIsQ0FBRjtBQUNKLElBQUksU0FBUyxRQUFRLFFBQVIsRUFBa0IsU0FBbEIsQ0FBNEIsUUFBNUIsQ0FBVDtBQUNKLE9BQU8sUUFBUCxDQUFnQixPQUFoQjs7QUFFQSxTQUFTLE9BQVQsQ0FBaUIsTUFBakIsRUFBeUI7O0FBRXZCLE1BQUksT0FBTyxRQUFRLGNBQVIsRUFBd0IsT0FBTyxJQUFQLENBQS9CLENBRm1COztBQUl2QixTQUFPLElBQVAsQ0FBWSxRQUFaLEVBQ0UsVUFBUyxHQUFULEVBQWMsR0FBZCxFQUFtQixJQUFuQixFQUF5QjtBQUN6QixTQUFLLFVBQUwsQ0FBZ0IsSUFBSSxJQUFKLENBQWhCLENBQTBCLElBQTFCLENBQStCLGlCQUFTO0FBQ3RDLFVBQUksSUFBSixDQUFTLEtBQVQsRUFEc0M7S0FBVCxDQUEvQixDQUVHLEtBRkgsQ0FFUyxhQUFLO0FBQ1osYUFBTyxLQUFQLENBQWEsQ0FBYixFQURZO0FBRVosVUFBSSxNQUFKLENBQVcsR0FBWCxFQUFnQixHQUFoQixHQUZZO0tBQUwsQ0FGVCxDQUR5QjtHQUF6QixDQURGLENBSnVCOztBQWV2QixTQUFPLElBQVAsQ0FBWSxjQUFaLEVBQ0UsVUFBUyxHQUFULEVBQWMsR0FBZCxFQUFtQixJQUFuQixFQUF5QjtBQUN6QixXQUFPLEtBQVAsQ0FBYSxJQUFJLElBQUosQ0FBYixDQUR5Qjs7QUFHekIsU0FBSyxjQUFMLENBQW9CLElBQUksTUFBSixDQUFXLEdBQVgs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UCxDQUFjLE9BQWQsRUFDRSxVQUFTLEdBQVQsRUFBYyxHQUFkLEVBQW1CLElBQW5CLEVBQXlCO0FBQ3pCLFNBQUssTUFBTCxDQUFZLElBQUksTUFBSixDQUFXLEdBQVgsQ0FBWixDQUE0QixJQUE1QixDQUFpQyxZQUFNO0FBQ3JDLFVBQUksSUFBSixDQUFTLENBQUMsSUFBSSxNQUFKLENBQVcsR0FBWCxDQUFWLEVBRHFDO0tBQU4sQ0FBakMsQ0FFRyxLQUZILENBRVMsYUFBSztBQUNaLGFBQU8sS0FBUCxDQUFhLENBQWIsRUFEWTtBQUVaLFVBQUksTUFBSixDQUFXLEdBQVgsRUFBZ0IsR0FBaEIsR0FGWTtLQUFMLENBRlQsQ0FEeUI7R0FBekIsQ0FERixDQWpKdUI7O0FBMkp2QixTQUFPLE1BQVAsQ0EzSnVCO0NBQXpCOztBQThKQSxPQUFPLE9BQVAsR0FBaUIsT0FBakIiLCJmaWxlIjoidHJlZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xudmFyIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG52YXIgZnMgPSByZXF1aXJlKCdibHVlYmlyZCcpLnByb21pc2lmeUFsbChyZXF1aXJlKCdmcy1leHRyYScpKTtcbnZhciBwYXRoPXJlcXVpcmUoJ3BhdGgnKTtcbnZhciBfPXJlcXVpcmUoJ2xvZGFzaCcpO1xudmFyIGxvZ2dlciA9IHJlcXVpcmUoJ2xvZzRqcycpLmdldExvZ2dlcignc2VydmVyJyk7XG5sb2dnZXIuc2V0TGV2ZWwoJ0RFQlVHJyk7IC8v56iL5bqP5a6M5oiQ5ZCO5rOo6YeK5o6J44CC5Y+v5Lul5YiH5o2i5Zue6buY6K6k562J57qn77yM5YeP5bCRbG9nXG5cbmZ1bmN0aW9uIGZhY3RvcnkoY29uZmlnKSB7XG5cbiAgdmFyIHRyZWUgPSByZXF1aXJlKCcuLi90cmVlLW5lZGInKShjb25maWcubmVkYik7XG5cbiAgcm91dGVyLnBvc3QoJy9ub2RlcycsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdHJlZS5yZWFkX25vZGVzKHJlcS5ib2R5KS50aGVuKG5vZGVzID0+IHtcbiAgICAgIHJlcy5qc29uKG5vZGVzKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cblxuICByb3V0ZXIucG9zdCgnL21rL3Nvbi86Z2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICBsb2dnZXIuZGVidWcocmVxLmJvZHkpO1xuXG4gICAgdHJlZS5ta19zb25fYnlfZGF0YShyZXEucGFyYW1zLmdpZCwgcmVxLmJvZHkpLnRoZW4obm9kZSA9PiB7XG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XG4gICAgICByZXMuanNvbihub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcm91dGVyLnBvc3QoJy9tay9zb25fbmFtZS86Z2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICBsb2dnZXIuZGVidWcocmVxLmJvZHkpO1xuXG4gICAgdHJlZS5ta19zb25fYnlfbmFtZShyZXEucGFyYW1zLmdpZCwgcmVxLmJvZHkubmFtZSkudGhlbihub2RlID0+IHtcbiAgICAgIC8vIGxvZ2dlci5kZWJ1Zyhub2RlKTtcbiAgICAgIHJlcy5qc29uKG5vZGUpO1xuICAgIH0pLmNhdGNoKGUgPT4ge1xuICAgICAgbG9nZ2VyLmVycm9yKGUpO1xuICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgIH0pO1xuICB9KTtcblxuXG4gIHJvdXRlci5wb3N0KCcvbWsvYnJvdGhlci86YmdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgLy8gcmVzLnNlbmQoJ21rIGJyb3RoZXIgb2YnK3JlcS5wYXJhbXMuYmdpZCk7XG4gICAgdHJlZS5ta19icm90aGVyX2J5X2RhdGEocmVxLmJvZHkscmVxLnBhcmFtcy5iZ2lkKS50aGVuKChub2RlKSA9PiB7XG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XG4gICAgICByZXMuanNvbihub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cblxuICByb3V0ZXIucG9zdCgnL212LzpzZ2lkL3Nvbi86ZGdpZCcsIFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdmFyIHAgPSByZXEucGFyYW1zO1xuICAgIC8vIGxvZ2dlci5kZWJ1ZyhgbXYgJHtwLnNnaWR9IGFzIHNvbiBvZiAke3AuZGdpZH1gKTtcbiAgICB0cmVlLm1vdmVfYXNfc29uKHAuc2dpZCxwLmRnaWQpLnRoZW4obm9kZSA9PiB7XG4gICAgICAvLyBsb2dnZXIuZGVidWcobm9kZSk7XG4gICAgICByZXMuanNvbihub2RlKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcm91dGVyLnBvc3QoJy9tdi86c2dpZC9icm90aGVyLzpkZ2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICB2YXIgcCA9IHJlcS5wYXJhbXM7XG4gICAgLy8gbG9nZ2VyLmRlYnVnKGBtdiAke3Auc2dpZH0gYXMgYnJvdGhlciBvZiAke3AuZGdpZH1gKTtcbiAgICB0cmVlLm1vdmVfYXNfYnJvdGhlcihwLnNnaWQscC5kZ2lkKS50aGVuKG5vZGUgPT4ge1xuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xuICAgICAgcmVzLmpzb24obm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG5cbiAgZnVuY3Rpb24gY2xvbmUob2JqKXtcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KG9iaikpO1xuICB9XG4gIFxuICBmdW5jdGlvbiBleHBhbmQobm9kZSxsZXZlbCl7IC8vbGV2ZWznlKjkuo7mjqfliLblsZXlvIDnmoTlsYLnuqdcbiAgICBpZihub2RlLl9saW5rLmNoaWxkcmVuLmxlbmd0aD09MCB8fCBsZXZlbDw9MCApeyAvL+S4jeWBmuWxleW8gOeahDLnp43mg4XlhrXjgIIxLuayoeacieWtkOiKgueCueOAgjLvvIzlsZXlvIDlsYLnuqflsI/kuo4wXG4gICAgICAgIHZhciBjbG9uZU5vZGU9Y2xvbmUobm9kZSk7XG4gICAgICAgIGNsb25lTm9kZS5fY2hpbGRyZW49W107XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2xvbmVOb2RlKTtcbiAgICB9ZWxzZXtcbiAgICAgICAgcmV0dXJuIHRyZWUucmVhZF9ub2Rlcyhub2RlLl9saW5rLmNoaWxkcmVuKVxuICAgICAgICAudGhlbihub2Rlcz0+e1xuICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnY2hpbGRyZW46Jyxub2RlLl9saW5rLmNoaWxkcmVuLCdub2Rlcycsbm9kZXMpXG4gICAgICAgICAgICBjb25zdCBmbm9kZXM9bm9kZXMubWFwKG5vZGU9PmV4cGFuZChub2RlLGxldmVsLTEpKTtcbiAgICAgICAgICAgIHJldHVybiBQcm9taXNlLmFsbChmbm9kZXMpLnRoZW4obm9kZXM9PntcbiAgICAgICAgICAgICAgICB2YXIgY2xvbmVOb2RlPWNsb25lKG5vZGUpO1xuICAgICAgICAgICAgICAgIGNsb25lTm9kZS5fY2hpbGRyZW49bm9kZXN8fFtdOyAvL+WxleW8gOeahOiKgueCueaUvuWIsF9jaGlsZHJlbuS4rVxuICAgICAgICAgICAgICAgIHJldHVybiBjbG9uZU5vZGU7XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIHJlYWRfYmlnbm9kZShnaWQsbGV2ZWwpIHtcbiAgICByZXR1cm4gdHJlZS5yZWFkX25vZGUoZ2lkKS50aGVuKFxuICAgICAgbm9kZT0+ZXhwYW5kKG5vZGUsbGV2ZWwpXG4gICAgKTsgXG4gIH1cblxuICAvKiBHRVQgYXBpIC4gKi9cbiAgcm91dGVyLmdldCgnLzpnaWQnLFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgdHJlZS5yZWFkX25vZGUocmVxLnBhcmFtcy5naWQpLnRoZW4obm9kZT0+IHsgICAgXG4gICAgICByZXR1cm4gcmVzLmpzb24obm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gICAgLyogR0VUIGV4cGFuZGVkIG5vZGUgIC4gKi9cbiAgcm91dGVyLmdldCgnL2JpZ25vZGUvOmdpZC86bGV2ZWwnLFxuICAgIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICByZWFkX2JpZ25vZGUocmVxLnBhcmFtcy5naWQscmVxLnBhcmFtcy5sZXZlbCkudGhlbihub2RlPT4geyAgICBcbiAgICAgICAgcmV0dXJuIHJlcy5qc29uKG5vZGUpO1xuICAgICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgcmVzLnN0YXR1cyg1MDApLmVuZCgpO1xuICAgICAgfSk7XG4gIH0pO1xuXG4gIHJvdXRlci5wdXQoJy86Z2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICB0cmVlLnVwZGF0ZV9kYXRhKHJlcS5wYXJhbXMuZ2lkLCByZXEuYm9keSkudGhlbigobm9kZSkgPT4ge1xuICAgICAgLy8gbG9nZ2VyLmRlYnVnKG5vZGUpO1xuICAgICAgcmVzLmpzb24obm9kZSk7XG4gICAgICBzYXZlMmVsYXN0aWNzZWFyY2gobm9kZSk7XG4gICAgfSkuY2F0Y2goZSA9PiB7XG4gICAgICBsb2dnZXIuZXJyb3IoZSk7XG4gICAgICByZXMuc3RhdHVzKDUwMCkuZW5kKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJvdXRlci5kZWxldGUoJy86Z2lkJywgXG4gICAgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgICB0cmVlLnJlbW92ZShyZXEucGFyYW1zLmdpZCkudGhlbigoKSA9PiB7XG4gICAgICByZXMuanNvbihbcmVxLnBhcmFtcy5naWRdKTtcbiAgICB9KS5jYXRjaChlID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihlKTtcbiAgICAgIHJlcy5zdGF0dXMoNTAwKS5lbmQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgcmV0dXJuIHJvdXRlcjtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5OyJdfQ==