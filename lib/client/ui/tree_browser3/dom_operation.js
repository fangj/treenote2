"use strict";

var cardImage = require('./handcard');
if (!window.$) {
  console.warn("need jQuery");
}
function scroll2card(id) {
  if (!window.$) return;
  var card = $("#" + id);
  if (!card || !card.offset()) return;
  var cardX = card.offset().left;
  var cardY = card.offset().top;
  var newPos = { scrollLeft: cardX - 200 };
  if (cardY > window.scrollY + window.innerHeight / 2) {
    //如果卡片位置在屏幕的下半部分以下。则移动到屏幕上部
    newPos.scrollTop = cardY - 20;
  }
  $('html,body').animate(newPos, 800); //只改变横坐标
}
var dragSource, over;
var placeholder = document.createElement("div");
placeholder.className = "placeholder";

function drag(ev) {
  var moveButton = ev.target;
  var menu = moveButton.parentElement;
  var main = menu.parentElement;
  var node = main.parentElement;
  dragSource = node;
  $(node).css('opacity', '0.5'); //淡化要移动的节点
  $(node).children(".children").hide(); //不能够移动到子节点，所以隐藏子节点避免成为drop target
  // console.log("node",node)
  var dt = ev.dataTransfer;
  dt.setData('text/plain', node.id);
  dt.setDragImage(cardImage, 100, 50);
  dt.effectAllowed = "move";
  $(".focus").removeClass('focus'); //避免宽元素放到窄列中,方便移动
}

function dragEnd(ev) {
  $(dragSource).css('opacity', '1'); //恢复：淡化要移动的节点
  if (placeholder.parentNode) {
    placeholder.parentNode.removeChild(placeholder); //清除黄色占位块
  }
}

function drop(ev) {
  // console.log('drop')
  ev.preventDefault();
  var sourceID = ev.dataTransfer.getData("text/plain");
  var targetNode = $(ev.target).closest(".node").get(0);
  // console.log("targetNode",targetNode);
  var sourceNode = document.getElementById(sourceID);

  if (sourceID == targetNode.id) {
    return; //相同元素不移动
  }
  // targetNode.parentElement.insertBefore(sourceNode,targetNode.nextElementSibling); //不再需要，因为react会重塑节点
  PubSub.publish("TreeBrowser", { msg: "move", gid: sourceID, bgid: targetNode.id });
}
function allowDrop(ev) {
  ev.preventDefault();
}
function dragover(ev) {
  allowDrop(ev);
  if (ev.target.className == "placeholder") return;
  var targetNode = $(ev.target).closest(".node").get(0);
  over = targetNode;
  targetNode.parentNode.insertBefore(placeholder, targetNode.nextElementSibling);
}

function ensureFocusColumn(focus) {
  $("#" + focus).closest(".children").addClass("focus");
}

module.exports = {
  scroll2card: scroll2card,
  drag: drag, drop: drop, dragEnd: dragEnd,
  dragover: dragover,
  ensureFocusColumn: ensureFocusColumn
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvdWkvdHJlZV9icm93c2VyMy9kb21fb3BlcmF0aW9uLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxZQUFVLFFBQVEsWUFBUixDQUFkO0FBQ0EsSUFBRyxDQUFDLE9BQU8sQ0FBWCxFQUFhO0FBQ1gsVUFBUSxJQUFSLENBQWEsYUFBYjtBQUNEO0FBQ0QsU0FBUyxXQUFULENBQXFCLEVBQXJCLEVBQXdCO0FBQ3RCLE1BQUcsQ0FBQyxPQUFPLENBQVgsRUFBYTtBQUNiLE1BQUksT0FBSyxFQUFFLE1BQUksRUFBTixDQUFUO0FBQ0EsTUFBRyxDQUFDLElBQUQsSUFBUyxDQUFDLEtBQUssTUFBTCxFQUFiLEVBQTJCO0FBQzNCLE1BQUksUUFBTSxLQUFLLE1BQUwsR0FBYyxJQUF4QjtBQUNBLE1BQUksUUFBTSxLQUFLLE1BQUwsR0FBYyxHQUF4QjtBQUNBLE1BQUksU0FBTyxFQUFDLFlBQVcsUUFBTSxHQUFsQixFQUFYO0FBQ0EsTUFBRyxRQUFPLE9BQU8sT0FBUCxHQUFlLE9BQU8sV0FBUCxHQUFtQixDQUE1QyxFQUErQztBQUM3QztBQUNBLFdBQU8sU0FBUCxHQUFpQixRQUFNLEVBQXZCO0FBQ0Q7QUFDRCxJQUFFLFdBQUYsRUFBZSxPQUFmLENBQXVCLE1BQXZCLEVBQStCLEdBQS9CLEVBWHNCLENBV2U7QUFDdEM7QUFDRCxJQUFJLFVBQUosRUFBZSxJQUFmO0FBQ0EsSUFBSSxjQUFjLFNBQVMsYUFBVCxDQUF1QixLQUF2QixDQUFsQjtBQUNBLFlBQVksU0FBWixHQUF3QixhQUF4Qjs7QUFFQSxTQUFTLElBQVQsQ0FBYyxFQUFkLEVBQWlCO0FBQ2YsTUFBSSxhQUFXLEdBQUcsTUFBbEI7QUFDQSxNQUFJLE9BQUssV0FBVyxhQUFwQjtBQUNBLE1BQUksT0FBSyxLQUFLLGFBQWQ7QUFDQSxNQUFJLE9BQUssS0FBSyxhQUFkO0FBQ0EsZUFBVyxJQUFYO0FBQ0EsSUFBRSxJQUFGLEVBQVEsR0FBUixDQUFZLFNBQVosRUFBc0IsS0FBdEIsRUFOZSxDQU1jO0FBQzdCLElBQUUsSUFBRixFQUFRLFFBQVIsQ0FBaUIsV0FBakIsRUFBOEIsSUFBOUIsR0FQZSxDQU91QjtBQUN0QztBQUNBLE1BQUksS0FBSyxHQUFHLFlBQVo7QUFDQSxLQUFHLE9BQUgsQ0FBVyxZQUFYLEVBQXdCLEtBQUssRUFBN0I7QUFDQSxLQUFHLFlBQUgsQ0FBZ0IsU0FBaEIsRUFBMkIsR0FBM0IsRUFBZ0MsRUFBaEM7QUFDQSxLQUFHLGFBQUgsR0FBbUIsTUFBbkI7QUFDQSxJQUFFLFFBQUYsRUFBWSxXQUFaLENBQXdCLE9BQXhCLEVBYmUsQ0Fha0I7QUFDbEM7O0FBRUQsU0FBUyxPQUFULENBQWlCLEVBQWpCLEVBQW9CO0FBQ2xCLElBQUUsVUFBRixFQUFjLEdBQWQsQ0FBa0IsU0FBbEIsRUFBNEIsR0FBNUIsRUFEa0IsQ0FDZTtBQUNqQyxNQUFHLFlBQVksVUFBZixFQUEwQjtBQUN4QixnQkFBWSxVQUFaLENBQXVCLFdBQXZCLENBQW1DLFdBQW5DLEVBRHdCLENBQ3dCO0FBQ2pEO0FBQ0Y7O0FBRUQsU0FBUyxJQUFULENBQWMsRUFBZCxFQUFpQjtBQUNmO0FBQ0EsS0FBRyxjQUFIO0FBQ0EsTUFBSSxXQUFXLEdBQUcsWUFBSCxDQUFnQixPQUFoQixDQUF3QixZQUF4QixDQUFmO0FBQ0EsTUFBSSxhQUFXLEVBQUcsR0FBRyxNQUFOLEVBQWUsT0FBZixDQUF1QixPQUF2QixFQUFnQyxHQUFoQyxDQUFvQyxDQUFwQyxDQUFmO0FBQ0E7QUFDQSxNQUFJLGFBQVcsU0FBUyxjQUFULENBQXdCLFFBQXhCLENBQWY7O0FBRUEsTUFBRyxZQUFVLFdBQVcsRUFBeEIsRUFBMkI7QUFDekIsV0FEeUIsQ0FDbEI7QUFDUjtBQUNEO0FBQ0EsU0FBTyxPQUFQLENBQWUsYUFBZixFQUE2QixFQUFDLEtBQUksTUFBTCxFQUFZLEtBQUksUUFBaEIsRUFBeUIsTUFBSyxXQUFXLEVBQXpDLEVBQTdCO0FBQ0Q7QUFDRCxTQUFTLFNBQVQsQ0FBbUIsRUFBbkIsRUFBdUI7QUFDbkIsS0FBRyxjQUFIO0FBQ0g7QUFDRCxTQUFTLFFBQVQsQ0FBa0IsRUFBbEIsRUFBcUI7QUFDbkIsWUFBVSxFQUFWO0FBQ0EsTUFBRyxHQUFHLE1BQUgsQ0FBVSxTQUFWLElBQXVCLGFBQTFCLEVBQXlDO0FBQ3pDLE1BQUksYUFBVyxFQUFHLEdBQUcsTUFBTixFQUFlLE9BQWYsQ0FBdUIsT0FBdkIsRUFBZ0MsR0FBaEMsQ0FBb0MsQ0FBcEMsQ0FBZjtBQUNBLFNBQU8sVUFBUDtBQUNBLGFBQVcsVUFBWCxDQUFzQixZQUF0QixDQUFtQyxXQUFuQyxFQUFnRCxXQUFXLGtCQUEzRDtBQUNEOztBQUVELFNBQVMsaUJBQVQsQ0FBMkIsS0FBM0IsRUFBaUM7QUFDL0IsSUFBRSxNQUFJLEtBQU4sRUFBYSxPQUFiLENBQXFCLFdBQXJCLEVBQWtDLFFBQWxDLENBQTJDLE9BQTNDO0FBQ0Q7O0FBR0QsT0FBTyxPQUFQLEdBQWU7QUFDYiwwQkFEYTtBQUViLFlBRmEsRUFFUixVQUZRLEVBRUgsZ0JBRkc7QUFHYixvQkFIYTtBQUliO0FBSmEsQ0FBZiIsImZpbGUiOiJkb21fb3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGNhcmRJbWFnZT1yZXF1aXJlKCcuL2hhbmRjYXJkJyk7XHJcbmlmKCF3aW5kb3cuJCl7XHJcbiAgY29uc29sZS53YXJuKFwibmVlZCBqUXVlcnlcIik7XHJcbn1cclxuZnVuY3Rpb24gc2Nyb2xsMmNhcmQoaWQpe1xyXG4gIGlmKCF3aW5kb3cuJClyZXR1cm47XHJcbiAgdmFyIGNhcmQ9JChcIiNcIitpZCk7XHJcbiAgaWYoIWNhcmQgfHwgIWNhcmQub2Zmc2V0KCkpcmV0dXJuO1xyXG4gIHZhciBjYXJkWD1jYXJkLm9mZnNldCgpLmxlZnQ7XHJcbiAgdmFyIGNhcmRZPWNhcmQub2Zmc2V0KCkudG9wO1xyXG4gIHZhciBuZXdQb3M9e3Njcm9sbExlZnQ6Y2FyZFgtMjAwfTtcclxuICBpZihjYXJkWT4od2luZG93LnNjcm9sbFkrd2luZG93LmlubmVySGVpZ2h0LzIpKXtcclxuICAgIC8v5aaC5p6c5Y2h54mH5L2N572u5Zyo5bGP5bmV55qE5LiL5Y2K6YOo5YiG5Lul5LiL44CC5YiZ56e75Yqo5Yiw5bGP5bmV5LiK6YOoXHJcbiAgICBuZXdQb3Muc2Nyb2xsVG9wPWNhcmRZLTIwO1xyXG4gIH1cclxuICAkKCdodG1sLGJvZHknKS5hbmltYXRlKG5ld1BvcywgODAwKTsgLy/lj6rmlLnlj5jmqKrlnZDmoIdcclxufVxyXG52YXIgZHJhZ1NvdXJjZSxvdmVyO1xyXG52YXIgcGxhY2Vob2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG5wbGFjZWhvbGRlci5jbGFzc05hbWUgPSBcInBsYWNlaG9sZGVyXCI7XHJcblxyXG5mdW5jdGlvbiBkcmFnKGV2KXtcclxuICB2YXIgbW92ZUJ1dHRvbj1ldi50YXJnZXQ7XHJcbiAgdmFyIG1lbnU9bW92ZUJ1dHRvbi5wYXJlbnRFbGVtZW50O1xyXG4gIHZhciBtYWluPW1lbnUucGFyZW50RWxlbWVudDtcclxuICB2YXIgbm9kZT1tYWluLnBhcmVudEVsZW1lbnQ7XHJcbiAgZHJhZ1NvdXJjZT1ub2RlO1xyXG4gICQobm9kZSkuY3NzKCdvcGFjaXR5JywnMC41Jyk7Ly/mt6HljJbopoHnp7vliqjnmoToioLngrlcclxuICAkKG5vZGUpLmNoaWxkcmVuKFwiLmNoaWxkcmVuXCIpLmhpZGUoKTsgLy/kuI3og73lpJ/np7vliqjliLDlrZDoioLngrnvvIzmiYDku6XpmpDol4/lrZDoioLngrnpgb/lhY3miJDkuLpkcm9wIHRhcmdldFxyXG4gIC8vIGNvbnNvbGUubG9nKFwibm9kZVwiLG5vZGUpXHJcbiAgdmFyIGR0ID0gZXYuZGF0YVRyYW5zZmVyO1xyXG4gIGR0LnNldERhdGEoJ3RleHQvcGxhaW4nLG5vZGUuaWQpO1xyXG4gIGR0LnNldERyYWdJbWFnZShjYXJkSW1hZ2UsIDEwMCwgNTApO1xyXG4gIGR0LmVmZmVjdEFsbG93ZWQgPSBcIm1vdmVcIjtcclxuICAkKFwiLmZvY3VzXCIpLnJlbW92ZUNsYXNzKCdmb2N1cycpOy8v6YG/5YWN5a695YWD57Sg5pS+5Yiw56qE5YiX5LitLOaWueS+v+enu+WKqFxyXG59XHJcblxyXG5mdW5jdGlvbiBkcmFnRW5kKGV2KXtcclxuICAkKGRyYWdTb3VyY2UpLmNzcygnb3BhY2l0eScsJzEnKTsvL+aBouWkje+8mua3oeWMluimgeenu+WKqOeahOiKgueCuVxyXG4gIGlmKHBsYWNlaG9sZGVyLnBhcmVudE5vZGUpe1xyXG4gICAgcGxhY2Vob2xkZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwbGFjZWhvbGRlcik7Ly/muIXpmaTpu4ToibLljaDkvY3lnZdcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyb3AoZXYpe1xyXG4gIC8vIGNvbnNvbGUubG9nKCdkcm9wJylcclxuICBldi5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIHZhciBzb3VyY2VJRCA9IGV2LmRhdGFUcmFuc2Zlci5nZXREYXRhKFwidGV4dC9wbGFpblwiKTtcclxuICB2YXIgdGFyZ2V0Tm9kZT0kKCBldi50YXJnZXQgKS5jbG9zZXN0KFwiLm5vZGVcIikuZ2V0KDApO1xyXG4gIC8vIGNvbnNvbGUubG9nKFwidGFyZ2V0Tm9kZVwiLHRhcmdldE5vZGUpO1xyXG4gIHZhciBzb3VyY2VOb2RlPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNvdXJjZUlEKTtcclxuICBcclxuICBpZihzb3VyY2VJRD09dGFyZ2V0Tm9kZS5pZCl7XHJcbiAgICByZXR1cm47Ly/nm7jlkIzlhYPntKDkuI3np7vliqhcclxuICB9XHJcbiAgLy8gdGFyZ2V0Tm9kZS5wYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShzb3VyY2VOb2RlLHRhcmdldE5vZGUubmV4dEVsZW1lbnRTaWJsaW5nKTsgLy/kuI3lho3pnIDopoHvvIzlm6DkuLpyZWFjdOS8mumHjeWhkeiKgueCuVxyXG4gIFB1YlN1Yi5wdWJsaXNoKFwiVHJlZUJyb3dzZXJcIix7bXNnOlwibW92ZVwiLGdpZDpzb3VyY2VJRCxiZ2lkOnRhcmdldE5vZGUuaWR9KTtcclxufVxyXG5mdW5jdGlvbiBhbGxvd0Ryb3AoZXYpIHtcclxuICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XHJcbn1cclxuZnVuY3Rpb24gZHJhZ292ZXIoZXYpe1xyXG4gIGFsbG93RHJvcChldik7XHJcbiAgaWYoZXYudGFyZ2V0LmNsYXNzTmFtZSA9PSBcInBsYWNlaG9sZGVyXCIpIHJldHVybjtcclxuICB2YXIgdGFyZ2V0Tm9kZT0kKCBldi50YXJnZXQgKS5jbG9zZXN0KFwiLm5vZGVcIikuZ2V0KDApO1xyXG4gIG92ZXIgPSB0YXJnZXROb2RlO1xyXG4gIHRhcmdldE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocGxhY2Vob2xkZXIsIHRhcmdldE5vZGUubmV4dEVsZW1lbnRTaWJsaW5nKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZW5zdXJlRm9jdXNDb2x1bW4oZm9jdXMpe1xyXG4gICQoXCIjXCIrZm9jdXMpLmNsb3Nlc3QoXCIuY2hpbGRyZW5cIikuYWRkQ2xhc3MoXCJmb2N1c1wiKTtcclxufVxyXG5cclxuXHJcbm1vZHVsZS5leHBvcnRzPXtcclxuICBzY3JvbGwyY2FyZCxcclxuICBkcmFnLGRyb3AsZHJhZ0VuZCxcclxuICBkcmFnb3ZlcixcclxuICBlbnN1cmVGb2N1c0NvbHVtblxyXG59Il19