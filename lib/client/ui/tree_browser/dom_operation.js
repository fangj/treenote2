"use strict";

var cardImage = require('./handcard');
if (!window.$) {
  console.warn("need jQuery");
}
function scroll2card(id) {
  if (!window.$) return;
  var card = $("#" + id);
  if (!card || !card.offset()) return;
  var cardX = card.offset().left;
  var cardY = card.offset().top;
  var newPos = { scrollLeft: cardX - 200 };
  if (cardY > window.scrollY + window.innerHeight / 2) {
    //如果卡片位置在屏幕的下半部分以下。则移动到屏幕上部
    newPos.scrollTop = cardY - 20;
  }
  $('html,body').animate(newPos, 800); //只改变横坐标
}
var dragSource, over;
var placeholder = document.createElement("div");
placeholder.className = "placeholder";

function drag(ev) {
  var moveButton = ev.target;
  var menu = moveButton.parentElement;
  var main = menu.parentElement;
  var node = main.parentElement;
  dragSource = node;
  $(node).css('opacity', '0.5'); //淡化要移动的节点
  $(node).children(".children").hide(); //不能够移动到子节点，所以隐藏子节点避免成为drop target
  // console.log("node",node)
  var dt = ev.dataTransfer;
  dt.setData('text/plain', node.id);
  dt.setDragImage(cardImage, 100, 50);
  dt.effectAllowed = "move";
  $(".focus").removeClass('focus'); //避免宽元素放到窄列中,方便移动
}

function dragEnd(ev) {
  $(dragSource).css('opacity', '1'); //恢复：淡化要移动的节点
  if (placeholder.parentNode) {
    placeholder.parentNode.removeChild(placeholder); //清除黄色占位块
  }
}

function drop(ev) {
  // console.log('drop')
  ev.preventDefault();
  var sourceID = ev.dataTransfer.getData("text/plain");
  var targetNode = $(ev.target).closest(".node").get(0);
  // console.log("targetNode",targetNode);
  var sourceNode = document.getElementById(sourceID);

  if (sourceID == targetNode.id) {
    return; //相同元素不移动
  }
  // targetNode.parentElement.insertBefore(sourceNode,targetNode.nextElementSibling); //不再需要，因为react会重塑节点
  PubSub.publish("TreeBrowser", { msg: "move", gid: sourceID, bgid: targetNode.id });
}
function allowDrop(ev) {
  ev.preventDefault();
}
function dragover(ev) {
  allowDrop(ev);
  if (ev.target.className == "placeholder") return;
  var targetNode = $(ev.target).closest(".node").get(0);
  over = targetNode;
  targetNode.parentNode.insertBefore(placeholder, targetNode.nextElementSibling);
}

function ensureFocusColumn(focus) {
  $("#" + focus).closest(".children").addClass("focus"); //拖拽后保证focus,以免新旧卡片尺寸不一致
}

module.exports = {
  scroll2card: scroll2card,
  drag: drag, drop: drop, dragEnd: dragEnd,
  dragover: dragover,
  ensureFocusColumn: ensureFocusColumn
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvdWkvdHJlZV9icm93c2VyL2RvbV9vcGVyYXRpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLFlBQVUsUUFBUSxZQUFSLENBQWQ7QUFDQSxJQUFHLENBQUMsT0FBTyxDQUFYLEVBQWE7QUFDWCxVQUFRLElBQVIsQ0FBYSxhQUFiO0FBQ0Q7QUFDRCxTQUFTLFdBQVQsQ0FBcUIsRUFBckIsRUFBd0I7QUFDdEIsTUFBRyxDQUFDLE9BQU8sQ0FBWCxFQUFhO0FBQ2IsTUFBSSxPQUFLLEVBQUUsTUFBSSxFQUFOLENBQVQ7QUFDQSxNQUFHLENBQUMsSUFBRCxJQUFTLENBQUMsS0FBSyxNQUFMLEVBQWIsRUFBMkI7QUFDM0IsTUFBSSxRQUFNLEtBQUssTUFBTCxHQUFjLElBQXhCO0FBQ0EsTUFBSSxRQUFNLEtBQUssTUFBTCxHQUFjLEdBQXhCO0FBQ0EsTUFBSSxTQUFPLEVBQUMsWUFBVyxRQUFNLEdBQWxCLEVBQVg7QUFDQSxNQUFHLFFBQU8sT0FBTyxPQUFQLEdBQWUsT0FBTyxXQUFQLEdBQW1CLENBQTVDLEVBQStDO0FBQzdDO0FBQ0EsV0FBTyxTQUFQLEdBQWlCLFFBQU0sRUFBdkI7QUFDRDtBQUNELElBQUUsV0FBRixFQUFlLE9BQWYsQ0FBdUIsTUFBdkIsRUFBK0IsR0FBL0IsRUFYc0IsQ0FXZTtBQUN0QztBQUNELElBQUksVUFBSixFQUFlLElBQWY7QUFDQSxJQUFJLGNBQWMsU0FBUyxhQUFULENBQXVCLEtBQXZCLENBQWxCO0FBQ0EsWUFBWSxTQUFaLEdBQXdCLGFBQXhCOztBQUVBLFNBQVMsSUFBVCxDQUFjLEVBQWQsRUFBaUI7QUFDZixNQUFJLGFBQVcsR0FBRyxNQUFsQjtBQUNBLE1BQUksT0FBSyxXQUFXLGFBQXBCO0FBQ0EsTUFBSSxPQUFLLEtBQUssYUFBZDtBQUNBLE1BQUksT0FBSyxLQUFLLGFBQWQ7QUFDQSxlQUFXLElBQVg7QUFDQSxJQUFFLElBQUYsRUFBUSxHQUFSLENBQVksU0FBWixFQUFzQixLQUF0QixFQU5lLENBTWM7QUFDN0IsSUFBRSxJQUFGLEVBQVEsUUFBUixDQUFpQixXQUFqQixFQUE4QixJQUE5QixHQVBlLENBT3VCO0FBQ3RDO0FBQ0EsTUFBSSxLQUFLLEdBQUcsWUFBWjtBQUNBLEtBQUcsT0FBSCxDQUFXLFlBQVgsRUFBd0IsS0FBSyxFQUE3QjtBQUNBLEtBQUcsWUFBSCxDQUFnQixTQUFoQixFQUEyQixHQUEzQixFQUFnQyxFQUFoQztBQUNBLEtBQUcsYUFBSCxHQUFtQixNQUFuQjtBQUNBLElBQUUsUUFBRixFQUFZLFdBQVosQ0FBd0IsT0FBeEIsRUFiZSxDQWFrQjtBQUNsQzs7QUFFRCxTQUFTLE9BQVQsQ0FBaUIsRUFBakIsRUFBb0I7QUFDbEIsSUFBRSxVQUFGLEVBQWMsR0FBZCxDQUFrQixTQUFsQixFQUE0QixHQUE1QixFQURrQixDQUNlO0FBQ2pDLE1BQUcsWUFBWSxVQUFmLEVBQTBCO0FBQ3hCLGdCQUFZLFVBQVosQ0FBdUIsV0FBdkIsQ0FBbUMsV0FBbkMsRUFEd0IsQ0FDd0I7QUFDakQ7QUFDRjs7QUFFRCxTQUFTLElBQVQsQ0FBYyxFQUFkLEVBQWlCO0FBQ2Y7QUFDQSxLQUFHLGNBQUg7QUFDQSxNQUFJLFdBQVcsR0FBRyxZQUFILENBQWdCLE9BQWhCLENBQXdCLFlBQXhCLENBQWY7QUFDQSxNQUFJLGFBQVcsRUFBRyxHQUFHLE1BQU4sRUFBZSxPQUFmLENBQXVCLE9BQXZCLEVBQWdDLEdBQWhDLENBQW9DLENBQXBDLENBQWY7QUFDQTtBQUNBLE1BQUksYUFBVyxTQUFTLGNBQVQsQ0FBd0IsUUFBeEIsQ0FBZjs7QUFFQSxNQUFHLFlBQVUsV0FBVyxFQUF4QixFQUEyQjtBQUN6QixXQUR5QixDQUNsQjtBQUNSO0FBQ0Q7QUFDQSxTQUFPLE9BQVAsQ0FBZSxhQUFmLEVBQTZCLEVBQUMsS0FBSSxNQUFMLEVBQVksS0FBSSxRQUFoQixFQUF5QixNQUFLLFdBQVcsRUFBekMsRUFBN0I7QUFDRDtBQUNELFNBQVMsU0FBVCxDQUFtQixFQUFuQixFQUF1QjtBQUNuQixLQUFHLGNBQUg7QUFDSDtBQUNELFNBQVMsUUFBVCxDQUFrQixFQUFsQixFQUFxQjtBQUNuQixZQUFVLEVBQVY7QUFDQSxNQUFHLEdBQUcsTUFBSCxDQUFVLFNBQVYsSUFBdUIsYUFBMUIsRUFBeUM7QUFDekMsTUFBSSxhQUFXLEVBQUcsR0FBRyxNQUFOLEVBQWUsT0FBZixDQUF1QixPQUF2QixFQUFnQyxHQUFoQyxDQUFvQyxDQUFwQyxDQUFmO0FBQ0EsU0FBTyxVQUFQO0FBQ0EsYUFBVyxVQUFYLENBQXNCLFlBQXRCLENBQW1DLFdBQW5DLEVBQWdELFdBQVcsa0JBQTNEO0FBQ0Q7O0FBRUQsU0FBUyxpQkFBVCxDQUEyQixLQUEzQixFQUFpQztBQUMvQixJQUFFLE1BQUksS0FBTixFQUFhLE9BQWIsQ0FBcUIsV0FBckIsRUFBa0MsUUFBbEMsQ0FBMkMsT0FBM0MsRUFEK0IsQ0FDcUI7QUFDckQ7O0FBR0QsT0FBTyxPQUFQLEdBQWU7QUFDYiwwQkFEYTtBQUViLFlBRmEsRUFFUixVQUZRLEVBRUgsZ0JBRkc7QUFHYixvQkFIYTtBQUliO0FBSmEsQ0FBZiIsImZpbGUiOiJkb21fb3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGNhcmRJbWFnZT1yZXF1aXJlKCcuL2hhbmRjYXJkJyk7XHJcbmlmKCF3aW5kb3cuJCl7XHJcbiAgY29uc29sZS53YXJuKFwibmVlZCBqUXVlcnlcIik7XHJcbn1cclxuZnVuY3Rpb24gc2Nyb2xsMmNhcmQoaWQpe1xyXG4gIGlmKCF3aW5kb3cuJClyZXR1cm47XHJcbiAgdmFyIGNhcmQ9JChcIiNcIitpZCk7XHJcbiAgaWYoIWNhcmQgfHwgIWNhcmQub2Zmc2V0KCkpcmV0dXJuO1xyXG4gIHZhciBjYXJkWD1jYXJkLm9mZnNldCgpLmxlZnQ7XHJcbiAgdmFyIGNhcmRZPWNhcmQub2Zmc2V0KCkudG9wO1xyXG4gIHZhciBuZXdQb3M9e3Njcm9sbExlZnQ6Y2FyZFgtMjAwfTtcclxuICBpZihjYXJkWT4od2luZG93LnNjcm9sbFkrd2luZG93LmlubmVySGVpZ2h0LzIpKXtcclxuICAgIC8v5aaC5p6c5Y2h54mH5L2N572u5Zyo5bGP5bmV55qE5LiL5Y2K6YOo5YiG5Lul5LiL44CC5YiZ56e75Yqo5Yiw5bGP5bmV5LiK6YOoXHJcbiAgICBuZXdQb3Muc2Nyb2xsVG9wPWNhcmRZLTIwO1xyXG4gIH1cclxuICAkKCdodG1sLGJvZHknKS5hbmltYXRlKG5ld1BvcywgODAwKTsgLy/lj6rmlLnlj5jmqKrlnZDmoIdcclxufVxyXG52YXIgZHJhZ1NvdXJjZSxvdmVyO1xyXG52YXIgcGxhY2Vob2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xyXG5wbGFjZWhvbGRlci5jbGFzc05hbWUgPSBcInBsYWNlaG9sZGVyXCI7XHJcblxyXG5mdW5jdGlvbiBkcmFnKGV2KXtcclxuICB2YXIgbW92ZUJ1dHRvbj1ldi50YXJnZXQ7XHJcbiAgdmFyIG1lbnU9bW92ZUJ1dHRvbi5wYXJlbnRFbGVtZW50O1xyXG4gIHZhciBtYWluPW1lbnUucGFyZW50RWxlbWVudDtcclxuICB2YXIgbm9kZT1tYWluLnBhcmVudEVsZW1lbnQ7XHJcbiAgZHJhZ1NvdXJjZT1ub2RlO1xyXG4gICQobm9kZSkuY3NzKCdvcGFjaXR5JywnMC41Jyk7Ly/mt6HljJbopoHnp7vliqjnmoToioLngrlcclxuICAkKG5vZGUpLmNoaWxkcmVuKFwiLmNoaWxkcmVuXCIpLmhpZGUoKTsgLy/kuI3og73lpJ/np7vliqjliLDlrZDoioLngrnvvIzmiYDku6XpmpDol4/lrZDoioLngrnpgb/lhY3miJDkuLpkcm9wIHRhcmdldFxyXG4gIC8vIGNvbnNvbGUubG9nKFwibm9kZVwiLG5vZGUpXHJcbiAgdmFyIGR0ID0gZXYuZGF0YVRyYW5zZmVyO1xyXG4gIGR0LnNldERhdGEoJ3RleHQvcGxhaW4nLG5vZGUuaWQpO1xyXG4gIGR0LnNldERyYWdJbWFnZShjYXJkSW1hZ2UsIDEwMCwgNTApO1xyXG4gIGR0LmVmZmVjdEFsbG93ZWQgPSBcIm1vdmVcIjtcclxuICAkKFwiLmZvY3VzXCIpLnJlbW92ZUNsYXNzKCdmb2N1cycpOy8v6YG/5YWN5a695YWD57Sg5pS+5Yiw56qE5YiX5LitLOaWueS+v+enu+WKqFxyXG59XHJcblxyXG5mdW5jdGlvbiBkcmFnRW5kKGV2KXtcclxuICAkKGRyYWdTb3VyY2UpLmNzcygnb3BhY2l0eScsJzEnKTsvL+aBouWkje+8mua3oeWMluimgeenu+WKqOeahOiKgueCuVxyXG4gIGlmKHBsYWNlaG9sZGVyLnBhcmVudE5vZGUpe1xyXG4gICAgcGxhY2Vob2xkZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChwbGFjZWhvbGRlcik7Ly/muIXpmaTpu4ToibLljaDkvY3lnZdcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyb3AoZXYpe1xyXG4gIC8vIGNvbnNvbGUubG9nKCdkcm9wJylcclxuICBldi5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gIHZhciBzb3VyY2VJRCA9IGV2LmRhdGFUcmFuc2Zlci5nZXREYXRhKFwidGV4dC9wbGFpblwiKTtcclxuICB2YXIgdGFyZ2V0Tm9kZT0kKCBldi50YXJnZXQgKS5jbG9zZXN0KFwiLm5vZGVcIikuZ2V0KDApO1xyXG4gIC8vIGNvbnNvbGUubG9nKFwidGFyZ2V0Tm9kZVwiLHRhcmdldE5vZGUpO1xyXG4gIHZhciBzb3VyY2VOb2RlPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNvdXJjZUlEKTtcclxuICBcclxuICBpZihzb3VyY2VJRD09dGFyZ2V0Tm9kZS5pZCl7XHJcbiAgICByZXR1cm47Ly/nm7jlkIzlhYPntKDkuI3np7vliqhcclxuICB9XHJcbiAgLy8gdGFyZ2V0Tm9kZS5wYXJlbnRFbGVtZW50Lmluc2VydEJlZm9yZShzb3VyY2VOb2RlLHRhcmdldE5vZGUubmV4dEVsZW1lbnRTaWJsaW5nKTsgLy/kuI3lho3pnIDopoHvvIzlm6DkuLpyZWFjdOS8mumHjeWhkeiKgueCuVxyXG4gIFB1YlN1Yi5wdWJsaXNoKFwiVHJlZUJyb3dzZXJcIix7bXNnOlwibW92ZVwiLGdpZDpzb3VyY2VJRCxiZ2lkOnRhcmdldE5vZGUuaWR9KTtcclxufVxyXG5mdW5jdGlvbiBhbGxvd0Ryb3AoZXYpIHtcclxuICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XHJcbn1cclxuZnVuY3Rpb24gZHJhZ292ZXIoZXYpe1xyXG4gIGFsbG93RHJvcChldik7XHJcbiAgaWYoZXYudGFyZ2V0LmNsYXNzTmFtZSA9PSBcInBsYWNlaG9sZGVyXCIpIHJldHVybjtcclxuICB2YXIgdGFyZ2V0Tm9kZT0kKCBldi50YXJnZXQgKS5jbG9zZXN0KFwiLm5vZGVcIikuZ2V0KDApO1xyXG4gIG92ZXIgPSB0YXJnZXROb2RlO1xyXG4gIHRhcmdldE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocGxhY2Vob2xkZXIsIHRhcmdldE5vZGUubmV4dEVsZW1lbnRTaWJsaW5nKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZW5zdXJlRm9jdXNDb2x1bW4oZm9jdXMpe1xyXG4gICQoXCIjXCIrZm9jdXMpLmNsb3Nlc3QoXCIuY2hpbGRyZW5cIikuYWRkQ2xhc3MoXCJmb2N1c1wiKTsvL+aLluaLveWQjuS/neivgWZvY3VzLOS7peWFjeaWsOaXp+WNoeeJh+WwuuWvuOS4jeS4gOiHtFxyXG59XHJcblxyXG5cclxubW9kdWxlLmV4cG9ydHM9e1xyXG4gIHNjcm9sbDJjYXJkLFxyXG4gIGRyYWcsZHJvcCxkcmFnRW5kLFxyXG4gIGRyYWdvdmVyLFxyXG4gIGVuc3VyZUZvY3VzQ29sdW1uXHJcbn0iXX0=