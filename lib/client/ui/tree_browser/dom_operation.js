"use strict";

var cardImage = require('./handcard');
if (!window.$) {
  console.warn("need jQuery");
}
function scroll2card(id) {
  if (!window.$) return;
  var card = $("#" + id);
  if (!card || !card.offset()) return;
  var cardX = card.offset().left;
  var cardY = card.offset().top;
  var newPos = { scrollLeft: cardX - 200 };
  if (cardY > window.scrollY + window.innerHeight / 2) {
    //如果卡片位置在屏幕的下半部分以下。则移动到屏幕上部
    newPos.scrollTop = cardY - 20;
  }
  $('html,body').animate(newPos, 800); //只改变横坐标
}
var dragSource, over;
var placeholder = document.createElement("div");
placeholder.className = "placeholder";

function drag(ev) {
  var moveButton = ev.target;
  var menu = moveButton.parentElement;
  var main = menu.parentElement;
  var node = main.parentElement;
  dragSource = node;
  $(node).css('opacity', '0.5'); //淡化要移动的节点
  $(node).children(".children").hide(); //不能够移动到子节点，所以隐藏子节点避免成为drop target
  // console.log("node",node)
  var dt = ev.dataTransfer;
  dt.setData('text/plain', node.id);
  dt.setDragImage(cardImage, 100, 50);
  dt.effectAllowed = "move";
  $(".focus").removeClass('focus'); //避免宽元素放到窄列中,方便移动
}

function dragEnd(ev) {
  $(dragSource).css('opacity', '1'); //恢复：淡化要移动的节点
  if (placeholder.parentNode) {
    placeholder.parentNode.removeChild(placeholder); //清除黄色占位块
  }
}

function drop(ev) {
  // console.log('drop')
  ev.preventDefault();
  var sourceID = ev.dataTransfer.getData("text/plain");
  var targetNode = $(ev.target).closest(".node").get(0);
  // console.log("targetNode",targetNode);
  var sourceNode = document.getElementById(sourceID);

  if (sourceID == targetNode.id) {
    return; //相同元素不移动
  }
  // targetNode.parentElement.insertBefore(sourceNode,targetNode.nextElementSibling); //不再需要，因为react会重塑节点
  PubSub.publish("TreeBrowser", { msg: "move", gid: sourceID, bgid: targetNode.id });
}
function allowDrop(ev) {
  ev.preventDefault();
}
function dragover(ev) {
  allowDrop(ev);
  if (ev.target.className == "placeholder") return;
  var targetNode = $(ev.target).closest(".node").get(0);
  over = targetNode;
  targetNode.parentNode.insertBefore(placeholder, targetNode.nextElementSibling);
}

function ensureFocusColumn(focus) {
  $("#" + focus).closest(".children").addClass("focus");
}

module.exports = {
  scroll2card: scroll2card,
  drag: drag, drop: drop, dragEnd: dragEnd,
  dragover: dragover,
  ensureFocusColumn: ensureFocusColumn
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvdWkvdHJlZV9icm93c2VyL2RvbV9vcGVyYXRpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLFlBQVUsUUFBUSxZQUFSLENBQWQ7QUFDQSxJQUFHLENBQUMsT0FBTyxDQUFYLEVBQWE7QUFDWCxVQUFRLElBQVIsQ0FBYSxhQUFiO0FBQ0Q7QUFDRCxTQUFTLFdBQVQsQ0FBcUIsRUFBckIsRUFBd0I7QUFDdEIsTUFBRyxDQUFDLE9BQU8sQ0FBWCxFQUFhO0FBQ2IsTUFBSSxPQUFLLEVBQUUsTUFBSSxFQUFOLENBQVQ7QUFDQSxNQUFHLENBQUMsSUFBRCxJQUFTLENBQUMsS0FBSyxNQUFMLEVBQWIsRUFBMkI7QUFDM0IsTUFBSSxRQUFNLEtBQUssTUFBTCxHQUFjLElBQXhCO0FBQ0EsTUFBSSxRQUFNLEtBQUssTUFBTCxHQUFjLEdBQXhCO0FBQ0EsTUFBSSxTQUFPLEVBQUMsWUFBVyxRQUFNLEdBQWxCLEVBQVg7QUFDQSxNQUFHLFFBQU8sT0FBTyxPQUFQLEdBQWUsT0FBTyxXQUFQLEdBQW1CLENBQTVDLEVBQStDO0FBQzdDO0FBQ0EsV0FBTyxTQUFQLEdBQWlCLFFBQU0sRUFBdkI7QUFDRDtBQUNELElBQUUsV0FBRixFQUFlLE9BQWYsQ0FBdUIsTUFBdkIsRUFBK0IsR0FBL0IsRUFYc0IsQ0FXZTtBQUN0QztBQUNELElBQUksVUFBSixFQUFlLElBQWY7QUFDQSxJQUFJLGNBQWMsU0FBUyxhQUFULENBQXVCLEtBQXZCLENBQWxCO0FBQ0EsWUFBWSxTQUFaLEdBQXdCLGFBQXhCOztBQUVBLFNBQVMsSUFBVCxDQUFjLEVBQWQsRUFBaUI7QUFDZixNQUFJLGFBQVcsR0FBRyxNQUFsQjtBQUNBLE1BQUksT0FBSyxXQUFXLGFBQXBCO0FBQ0EsTUFBSSxPQUFLLEtBQUssYUFBZDtBQUNBLE1BQUksT0FBSyxLQUFLLGFBQWQ7QUFDQSxlQUFXLElBQVg7QUFDQSxJQUFFLElBQUYsRUFBUSxHQUFSLENBQVksU0FBWixFQUFzQixLQUF0QixFQU5lLENBTWM7QUFDN0IsSUFBRSxJQUFGLEVBQVEsUUFBUixDQUFpQixXQUFqQixFQUE4QixJQUE5QixHQVBlLENBT3VCO0FBQ3RDO0FBQ0EsTUFBSSxLQUFLLEdBQUcsWUFBWjtBQUNBLEtBQUcsT0FBSCxDQUFXLFlBQVgsRUFBd0IsS0FBSyxFQUE3QjtBQUNBLEtBQUcsWUFBSCxDQUFnQixTQUFoQixFQUEyQixHQUEzQixFQUFnQyxFQUFoQztBQUNBLEtBQUcsYUFBSCxHQUFtQixNQUFuQjtBQUNBLElBQUUsUUFBRixFQUFZLFdBQVosQ0FBd0IsT0FBeEIsRUFiZSxDQWFrQjtBQUNsQzs7QUFFRCxTQUFTLE9BQVQsQ0FBaUIsRUFBakIsRUFBb0I7QUFDbEIsSUFBRSxVQUFGLEVBQWMsR0FBZCxDQUFrQixTQUFsQixFQUE0QixHQUE1QixFQURrQixDQUNlO0FBQ2pDLE1BQUcsWUFBWSxVQUFmLEVBQTBCO0FBQ3hCLGdCQUFZLFVBQVosQ0FBdUIsV0FBdkIsQ0FBbUMsV0FBbkMsRUFEd0IsQ0FDd0I7QUFDakQ7QUFDRjs7QUFFRCxTQUFTLElBQVQsQ0FBYyxFQUFkLEVBQWlCO0FBQ2Y7QUFDQSxLQUFHLGNBQUg7QUFDQSxNQUFJLFdBQVcsR0FBRyxZQUFILENBQWdCLE9BQWhCLENBQXdCLFlBQXhCLENBQWY7QUFDQSxNQUFJLGFBQVcsRUFBRyxHQUFHLE1BQU4sRUFBZSxPQUFmLENBQXVCLE9BQXZCLEVBQWdDLEdBQWhDLENBQW9DLENBQXBDLENBQWY7QUFDQTtBQUNBLE1BQUksYUFBVyxTQUFTLGNBQVQsQ0FBd0IsUUFBeEIsQ0FBZjs7QUFFQSxNQUFHLFlBQVUsV0FBVyxFQUF4QixFQUEyQjtBQUN6QixXQUR5QixDQUNsQjtBQUNSO0FBQ0Q7QUFDQSxTQUFPLE9BQVAsQ0FBZSxhQUFmLEVBQTZCLEVBQUMsS0FBSSxNQUFMLEVBQVksS0FBSSxRQUFoQixFQUF5QixNQUFLLFdBQVcsRUFBekMsRUFBN0I7QUFDRDtBQUNELFNBQVMsU0FBVCxDQUFtQixFQUFuQixFQUF1QjtBQUNuQixLQUFHLGNBQUg7QUFDSDtBQUNELFNBQVMsUUFBVCxDQUFrQixFQUFsQixFQUFxQjtBQUNuQixZQUFVLEVBQVY7QUFDQSxNQUFHLEdBQUcsTUFBSCxDQUFVLFNBQVYsSUFBdUIsYUFBMUIsRUFBeUM7QUFDekMsTUFBSSxhQUFXLEVBQUcsR0FBRyxNQUFOLEVBQWUsT0FBZixDQUF1QixPQUF2QixFQUFnQyxHQUFoQyxDQUFvQyxDQUFwQyxDQUFmO0FBQ0EsU0FBTyxVQUFQO0FBQ0EsYUFBVyxVQUFYLENBQXNCLFlBQXRCLENBQW1DLFdBQW5DLEVBQWdELFdBQVcsa0JBQTNEO0FBQ0Q7O0FBRUQsU0FBUyxpQkFBVCxDQUEyQixLQUEzQixFQUFpQztBQUMvQixJQUFFLE1BQUksS0FBTixFQUFhLE9BQWIsQ0FBcUIsV0FBckIsRUFBa0MsUUFBbEMsQ0FBMkMsT0FBM0M7QUFDRDs7QUFHRCxPQUFPLE9BQVAsR0FBZTtBQUNiLDBCQURhO0FBRWIsWUFGYSxFQUVSLFVBRlEsRUFFSCxnQkFGRztBQUdiLG9CQUhhO0FBSWI7QUFKYSxDQUFmIiwiZmlsZSI6ImRvbV9vcGVyYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgY2FyZEltYWdlPXJlcXVpcmUoJy4vaGFuZGNhcmQnKTtcclxuaWYoIXdpbmRvdy4kKXtcclxuICBjb25zb2xlLndhcm4oXCJuZWVkIGpRdWVyeVwiKTtcclxufVxyXG5mdW5jdGlvbiBzY3JvbGwyY2FyZChpZCl7XHJcbiAgaWYoIXdpbmRvdy4kKXJldHVybjtcclxuICB2YXIgY2FyZD0kKFwiI1wiK2lkKTtcclxuICBpZighY2FyZCB8fCAhY2FyZC5vZmZzZXQoKSlyZXR1cm47XHJcbiAgdmFyIGNhcmRYPWNhcmQub2Zmc2V0KCkubGVmdDtcclxuICB2YXIgY2FyZFk9Y2FyZC5vZmZzZXQoKS50b3A7XHJcbiAgdmFyIG5ld1Bvcz17c2Nyb2xsTGVmdDpjYXJkWC0yMDB9O1xyXG4gIGlmKGNhcmRZPih3aW5kb3cuc2Nyb2xsWSt3aW5kb3cuaW5uZXJIZWlnaHQvMikpe1xyXG4gICAgLy/lpoLmnpzljaHniYfkvY3nva7lnKjlsY/luZXnmoTkuIvljYrpg6jliIbku6XkuIvjgILliJnnp7vliqjliLDlsY/luZXkuIrpg6hcclxuICAgIG5ld1Bvcy5zY3JvbGxUb3A9Y2FyZFktMjA7XHJcbiAgfVxyXG4gICQoJ2h0bWwsYm9keScpLmFuaW1hdGUobmV3UG9zLCA4MDApOyAvL+WPquaUueWPmOaoquWdkOagh1xyXG59XHJcbnZhciBkcmFnU291cmNlLG92ZXI7XHJcbnZhciBwbGFjZWhvbGRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbnBsYWNlaG9sZGVyLmNsYXNzTmFtZSA9IFwicGxhY2Vob2xkZXJcIjtcclxuXHJcbmZ1bmN0aW9uIGRyYWcoZXYpe1xyXG4gIHZhciBtb3ZlQnV0dG9uPWV2LnRhcmdldDtcclxuICB2YXIgbWVudT1tb3ZlQnV0dG9uLnBhcmVudEVsZW1lbnQ7XHJcbiAgdmFyIG1haW49bWVudS5wYXJlbnRFbGVtZW50O1xyXG4gIHZhciBub2RlPW1haW4ucGFyZW50RWxlbWVudDtcclxuICBkcmFnU291cmNlPW5vZGU7XHJcbiAgJChub2RlKS5jc3MoJ29wYWNpdHknLCcwLjUnKTsvL+a3oeWMluimgeenu+WKqOeahOiKgueCuVxyXG4gICQobm9kZSkuY2hpbGRyZW4oXCIuY2hpbGRyZW5cIikuaGlkZSgpOyAvL+S4jeiDveWkn+enu+WKqOWIsOWtkOiKgueCue+8jOaJgOS7pemakOiXj+WtkOiKgueCuemBv+WFjeaIkOS4umRyb3AgdGFyZ2V0XHJcbiAgLy8gY29uc29sZS5sb2coXCJub2RlXCIsbm9kZSlcclxuICB2YXIgZHQgPSBldi5kYXRhVHJhbnNmZXI7XHJcbiAgZHQuc2V0RGF0YSgndGV4dC9wbGFpbicsbm9kZS5pZCk7XHJcbiAgZHQuc2V0RHJhZ0ltYWdlKGNhcmRJbWFnZSwgMTAwLCA1MCk7XHJcbiAgZHQuZWZmZWN0QWxsb3dlZCA9IFwibW92ZVwiO1xyXG4gICQoXCIuZm9jdXNcIikucmVtb3ZlQ2xhc3MoJ2ZvY3VzJyk7Ly/pgb/lhY3lrr3lhYPntKDmlL7liLDnqoTliJfkuK0s5pa55L6/56e75YqoXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyYWdFbmQoZXYpe1xyXG4gICQoZHJhZ1NvdXJjZSkuY3NzKCdvcGFjaXR5JywnMScpOy8v5oGi5aSN77ya5reh5YyW6KaB56e75Yqo55qE6IqC54K5XHJcbiAgaWYocGxhY2Vob2xkZXIucGFyZW50Tm9kZSl7XHJcbiAgICBwbGFjZWhvbGRlci5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHBsYWNlaG9sZGVyKTsvL+a4hemZpOm7hOiJsuWNoOS9jeWdl1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZHJvcChldil7XHJcbiAgLy8gY29uc29sZS5sb2coJ2Ryb3AnKVxyXG4gIGV2LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgdmFyIHNvdXJjZUlEID0gZXYuZGF0YVRyYW5zZmVyLmdldERhdGEoXCJ0ZXh0L3BsYWluXCIpO1xyXG4gIHZhciB0YXJnZXROb2RlPSQoIGV2LnRhcmdldCApLmNsb3Nlc3QoXCIubm9kZVwiKS5nZXQoMCk7XHJcbiAgLy8gY29uc29sZS5sb2coXCJ0YXJnZXROb2RlXCIsdGFyZ2V0Tm9kZSk7XHJcbiAgdmFyIHNvdXJjZU5vZGU9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc291cmNlSUQpO1xyXG4gIFxyXG4gIGlmKHNvdXJjZUlEPT10YXJnZXROb2RlLmlkKXtcclxuICAgIHJldHVybjsvL+ebuOWQjOWFg+e0oOS4jeenu+WKqFxyXG4gIH1cclxuICAvLyB0YXJnZXROb2RlLnBhcmVudEVsZW1lbnQuaW5zZXJ0QmVmb3JlKHNvdXJjZU5vZGUsdGFyZ2V0Tm9kZS5uZXh0RWxlbWVudFNpYmxpbmcpOyAvL+S4jeWGjemcgOimge+8jOWboOS4unJlYWN05Lya6YeN5aGR6IqC54K5XHJcbiAgUHViU3ViLnB1Ymxpc2goXCJUcmVlQnJvd3NlclwiLHttc2c6XCJtb3ZlXCIsZ2lkOnNvdXJjZUlELGJnaWQ6dGFyZ2V0Tm9kZS5pZH0pO1xyXG59XHJcbmZ1bmN0aW9uIGFsbG93RHJvcChldikge1xyXG4gICAgZXYucHJldmVudERlZmF1bHQoKTtcclxufVxyXG5mdW5jdGlvbiBkcmFnb3Zlcihldil7XHJcbiAgYWxsb3dEcm9wKGV2KTtcclxuICBpZihldi50YXJnZXQuY2xhc3NOYW1lID09IFwicGxhY2Vob2xkZXJcIikgcmV0dXJuO1xyXG4gIHZhciB0YXJnZXROb2RlPSQoIGV2LnRhcmdldCApLmNsb3Nlc3QoXCIubm9kZVwiKS5nZXQoMCk7XHJcbiAgb3ZlciA9IHRhcmdldE5vZGU7XHJcbiAgdGFyZ2V0Tm9kZS5wYXJlbnROb2RlLmluc2VydEJlZm9yZShwbGFjZWhvbGRlciwgdGFyZ2V0Tm9kZS5uZXh0RWxlbWVudFNpYmxpbmcpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBlbnN1cmVGb2N1c0NvbHVtbihmb2N1cyl7XHJcbiAgJChcIiNcIitmb2N1cykuY2xvc2VzdChcIi5jaGlsZHJlblwiKS5hZGRDbGFzcyhcImZvY3VzXCIpO1xyXG59XHJcblxyXG5cclxubW9kdWxlLmV4cG9ydHM9e1xyXG4gIHNjcm9sbDJjYXJkLFxyXG4gIGRyYWcsZHJvcCxkcmFnRW5kLFxyXG4gIGRyYWdvdmVyLFxyXG4gIGVuc3VyZUZvY3VzQ29sdW1uXHJcbn0iXX0=