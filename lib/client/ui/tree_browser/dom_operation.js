"use strict";

var cardImage = require('./handcard');
if (!window.$) {
  console.warn("need jQuery");
}
function scroll2card(id) {
  if (!window.$) return;
  var card = $("#" + id);
  if (!card || !card.offset()) return;
  var cardX = card.offset().left;
  var cardY = card.offset().top;
  var newPos = { scrollLeft: cardX - 200 };
  if (cardY > window.scrollY + window.innerHeight / 2) {
    //如果卡片位置在屏幕的下半部分以下。则移动到屏幕上部
    newPos.scrollTop = cardY - 20;
  }
  $('html,body').animate(newPos, 800); //只改变横坐标
}
var dragSource, over;
var placeholder = document.createElement("div");
placeholder.className = "placeholder";

function drag(ev) {
  var moveButton = ev.target;
  var menu = moveButton.parentElement;
  var main = menu.parentElement;
  var node = main.parentElement;
  dragSource = node;
  $(node).css('opacity', '0.5'); //淡化要移动的节点
  $(node).children(".children").hide(); //不能够移动到子节点，所以隐藏子节点避免成为drop target
  // console.log("node",node)
  var dt = ev.dataTransfer;
  dt.setData('text/plain', node.id);
  dt.setDragImage(cardImage, 100, 50);
  dt.effectAllowed = "move";
  $(".focus").removeClass('focus'); //避免宽元素放到窄列中,方便移动
}

function dragEnd(ev) {
  $(dragSource).css('opacity', '1'); //恢复：淡化要移动的节点
  if (placeholder.parentNode) {
    placeholder.parentNode.removeChild(placeholder); //清除黄色占位块
  }
}

function drop(ev) {
  // console.log('drop')
  ev.preventDefault();
  var sourceID = ev.dataTransfer.getData("text/plain");
  var targetNode = $(ev.target).closest(".node").get(0);
  // console.log("targetNode",targetNode);
  var sourceNode = document.getElementById(sourceID);

  if (sourceID == targetNode.id) {
    return; //相同元素不移动
  }
  // targetNode.parentElement.insertBefore(sourceNode,targetNode.nextElementSibling); //不再需要，因为react会重塑节点
  PubSub.publish("TreeBrowser", { msg: "move", gid: sourceID, bgid: targetNode.id });
}
function allowDrop(ev) {
  ev.preventDefault();
}
function dragover(ev) {
  allowDrop(ev);
  if (ev.target.className == "placeholder") return;
  var targetNode = $(ev.target).closest(".node").get(0);
  over = targetNode;
  targetNode.parentNode.insertBefore(placeholder, targetNode.nextElementSibling);
}

function ensureFocusColumn(focus) {
  $("#" + focus).closest(".children").addClass("focus");
}

module.exports = {
  scroll2card: scroll2card,
  drag: drag, drop: drop, dragEnd: dragEnd,
  dragover: dragover,
  ensureFocusColumn: ensureFocusColumn
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jbGllbnQvdWkvdHJlZV9icm93c2VyL2RvbV9vcGVyYXRpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJLFlBQVUsUUFBUSxZQUFSLENBQVY7QUFDSixJQUFHLENBQUMsT0FBTyxDQUFQLEVBQVM7QUFDWCxVQUFRLElBQVIsQ0FBYSxhQUFiLEVBRFc7Q0FBYjtBQUdBLFNBQVMsV0FBVCxDQUFxQixFQUFyQixFQUF3QjtBQUN0QixNQUFHLENBQUMsT0FBTyxDQUFQLEVBQVMsT0FBYjtBQUNBLE1BQUksT0FBSyxFQUFFLE1BQUksRUFBSixDQUFQLENBRmtCO0FBR3RCLE1BQUcsQ0FBQyxJQUFELElBQVMsQ0FBQyxLQUFLLE1BQUwsRUFBRCxFQUFlLE9BQTNCO0FBQ0EsTUFBSSxRQUFNLEtBQUssTUFBTCxHQUFjLElBQWQsQ0FKWTtBQUt0QixNQUFJLFFBQU0sS0FBSyxNQUFMLEdBQWMsR0FBZCxDQUxZO0FBTXRCLE1BQUksU0FBTyxFQUFDLFlBQVcsUUFBTSxHQUFOLEVBQW5CLENBTmtCO0FBT3RCLE1BQUcsUUFBTyxPQUFPLE9BQVAsR0FBZSxPQUFPLFdBQVAsR0FBbUIsQ0FBbkIsRUFBc0I7O0FBRTdDLFdBQU8sU0FBUCxHQUFpQixRQUFNLEVBQU4sQ0FGNEI7R0FBL0M7QUFJQSxJQUFFLFdBQUYsRUFBZSxPQUFmLENBQXVCLE1BQXZCLEVBQStCLEdBQS9CO0FBWHNCLENBQXhCO0FBYUEsSUFBSSxVQUFKLEVBQWUsSUFBZjtBQUNBLElBQUksY0FBYyxTQUFTLGFBQVQsQ0FBdUIsS0FBdkIsQ0FBZDtBQUNKLFlBQVksU0FBWixHQUF3QixhQUF4Qjs7QUFFQSxTQUFTLElBQVQsQ0FBYyxFQUFkLEVBQWlCO0FBQ2YsTUFBSSxhQUFXLEdBQUcsTUFBSCxDQURBO0FBRWYsTUFBSSxPQUFLLFdBQVcsYUFBWCxDQUZNO0FBR2YsTUFBSSxPQUFLLEtBQUssYUFBTCxDQUhNO0FBSWYsTUFBSSxPQUFLLEtBQUssYUFBTCxDQUpNO0FBS2YsZUFBVyxJQUFYLENBTGU7QUFNZixJQUFFLElBQUYsRUFBUSxHQUFSLENBQVksU0FBWixFQUFzQixLQUF0QjtBQU5lLEdBT2YsQ0FBRSxJQUFGLEVBQVEsUUFBUixDQUFpQixXQUFqQixFQUE4QixJQUE5Qjs7QUFQZSxNQVNYLEtBQUssR0FBRyxZQUFILENBVE07QUFVZixLQUFHLE9BQUgsQ0FBVyxZQUFYLEVBQXdCLEtBQUssRUFBTCxDQUF4QixDQVZlO0FBV2YsS0FBRyxZQUFILENBQWdCLFNBQWhCLEVBQTJCLEdBQTNCLEVBQWdDLEVBQWhDLEVBWGU7QUFZZixLQUFHLGFBQUgsR0FBbUIsTUFBbkIsQ0FaZTtBQWFmLElBQUUsUUFBRixFQUFZLFdBQVosQ0FBd0IsT0FBeEI7QUFiZSxDQUFqQjs7QUFnQkEsU0FBUyxPQUFULENBQWlCLEVBQWpCLEVBQW9CO0FBQ2xCLElBQUUsVUFBRixFQUFjLEdBQWQsQ0FBa0IsU0FBbEIsRUFBNEIsR0FBNUI7QUFEa0IsTUFFZixZQUFZLFVBQVosRUFBdUI7QUFDeEIsZ0JBQVksVUFBWixDQUF1QixXQUF2QixDQUFtQyxXQUFuQztBQUR3QixHQUExQjtDQUZGOztBQU9BLFNBQVMsSUFBVCxDQUFjLEVBQWQsRUFBaUI7O0FBRWYsS0FBRyxjQUFILEdBRmU7QUFHZixNQUFJLFdBQVcsR0FBRyxZQUFILENBQWdCLE9BQWhCLENBQXdCLFlBQXhCLENBQVgsQ0FIVztBQUlmLE1BQUksYUFBVyxFQUFHLEdBQUcsTUFBSCxDQUFILENBQWUsT0FBZixDQUF1QixPQUF2QixFQUFnQyxHQUFoQyxDQUFvQyxDQUFwQyxDQUFYOztBQUpXLE1BTVgsYUFBVyxTQUFTLGNBQVQsQ0FBd0IsUUFBeEIsQ0FBWCxDQU5XOztBQVFmLE1BQUcsWUFBVSxXQUFXLEVBQVgsRUFBYztBQUN6QjtBQUR5QixHQUEzQjs7QUFSZSxRQVlmLENBQU8sT0FBUCxDQUFlLGFBQWYsRUFBNkIsRUFBQyxLQUFJLE1BQUosRUFBVyxLQUFJLFFBQUosRUFBYSxNQUFLLFdBQVcsRUFBWCxFQUEzRCxFQVplO0NBQWpCO0FBY0EsU0FBUyxTQUFULENBQW1CLEVBQW5CLEVBQXVCO0FBQ25CLEtBQUcsY0FBSCxHQURtQjtDQUF2QjtBQUdBLFNBQVMsUUFBVCxDQUFrQixFQUFsQixFQUFxQjtBQUNuQixZQUFVLEVBQVYsRUFEbUI7QUFFbkIsTUFBRyxHQUFHLE1BQUgsQ0FBVSxTQUFWLElBQXVCLGFBQXZCLEVBQXNDLE9BQXpDO0FBQ0EsTUFBSSxhQUFXLEVBQUcsR0FBRyxNQUFILENBQUgsQ0FBZSxPQUFmLENBQXVCLE9BQXZCLEVBQWdDLEdBQWhDLENBQW9DLENBQXBDLENBQVgsQ0FIZTtBQUluQixTQUFPLFVBQVAsQ0FKbUI7QUFLbkIsYUFBVyxVQUFYLENBQXNCLFlBQXRCLENBQW1DLFdBQW5DLEVBQWdELFdBQVcsa0JBQVgsQ0FBaEQsQ0FMbUI7Q0FBckI7O0FBUUEsU0FBUyxpQkFBVCxDQUEyQixLQUEzQixFQUFpQztBQUMvQixJQUFFLE1BQUksS0FBSixDQUFGLENBQWEsT0FBYixDQUFxQixXQUFyQixFQUFrQyxRQUFsQyxDQUEyQyxPQUEzQyxFQUQrQjtDQUFqQzs7QUFLQSxPQUFPLE9BQVAsR0FBZTtBQUNiLDBCQURhO0FBRWIsWUFGYSxFQUVSLFVBRlEsRUFFSCxnQkFGRztBQUdiLG9CQUhhO0FBSWIsc0NBSmE7Q0FBZiIsImZpbGUiOiJkb21fb3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGNhcmRJbWFnZT1yZXF1aXJlKCcuL2hhbmRjYXJkJyk7XG5pZighd2luZG93LiQpe1xuICBjb25zb2xlLndhcm4oXCJuZWVkIGpRdWVyeVwiKTtcbn1cbmZ1bmN0aW9uIHNjcm9sbDJjYXJkKGlkKXtcbiAgaWYoIXdpbmRvdy4kKXJldHVybjtcbiAgdmFyIGNhcmQ9JChcIiNcIitpZCk7XG4gIGlmKCFjYXJkIHx8ICFjYXJkLm9mZnNldCgpKXJldHVybjtcbiAgdmFyIGNhcmRYPWNhcmQub2Zmc2V0KCkubGVmdDtcbiAgdmFyIGNhcmRZPWNhcmQub2Zmc2V0KCkudG9wO1xuICB2YXIgbmV3UG9zPXtzY3JvbGxMZWZ0OmNhcmRYLTIwMH07XG4gIGlmKGNhcmRZPih3aW5kb3cuc2Nyb2xsWSt3aW5kb3cuaW5uZXJIZWlnaHQvMikpe1xuICAgIC8v5aaC5p6c5Y2h54mH5L2N572u5Zyo5bGP5bmV55qE5LiL5Y2K6YOo5YiG5Lul5LiL44CC5YiZ56e75Yqo5Yiw5bGP5bmV5LiK6YOoXG4gICAgbmV3UG9zLnNjcm9sbFRvcD1jYXJkWS0yMDtcbiAgfVxuICAkKCdodG1sLGJvZHknKS5hbmltYXRlKG5ld1BvcywgODAwKTsgLy/lj6rmlLnlj5jmqKrlnZDmoIdcbn1cbnZhciBkcmFnU291cmNlLG92ZXI7XG52YXIgcGxhY2Vob2xkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xucGxhY2Vob2xkZXIuY2xhc3NOYW1lID0gXCJwbGFjZWhvbGRlclwiO1xuXG5mdW5jdGlvbiBkcmFnKGV2KXtcbiAgdmFyIG1vdmVCdXR0b249ZXYudGFyZ2V0O1xuICB2YXIgbWVudT1tb3ZlQnV0dG9uLnBhcmVudEVsZW1lbnQ7XG4gIHZhciBtYWluPW1lbnUucGFyZW50RWxlbWVudDtcbiAgdmFyIG5vZGU9bWFpbi5wYXJlbnRFbGVtZW50O1xuICBkcmFnU291cmNlPW5vZGU7XG4gICQobm9kZSkuY3NzKCdvcGFjaXR5JywnMC41Jyk7Ly/mt6HljJbopoHnp7vliqjnmoToioLngrlcbiAgJChub2RlKS5jaGlsZHJlbihcIi5jaGlsZHJlblwiKS5oaWRlKCk7IC8v5LiN6IO95aSf56e75Yqo5Yiw5a2Q6IqC54K577yM5omA5Lul6ZqQ6JeP5a2Q6IqC54K56YG/5YWN5oiQ5Li6ZHJvcCB0YXJnZXRcbiAgLy8gY29uc29sZS5sb2coXCJub2RlXCIsbm9kZSlcbiAgdmFyIGR0ID0gZXYuZGF0YVRyYW5zZmVyO1xuICBkdC5zZXREYXRhKCd0ZXh0L3BsYWluJyxub2RlLmlkKTtcbiAgZHQuc2V0RHJhZ0ltYWdlKGNhcmRJbWFnZSwgMTAwLCA1MCk7XG4gIGR0LmVmZmVjdEFsbG93ZWQgPSBcIm1vdmVcIjtcbiAgJChcIi5mb2N1c1wiKS5yZW1vdmVDbGFzcygnZm9jdXMnKTsvL+mBv+WFjeWuveWFg+e0oOaUvuWIsOeqhOWIl+S4rSzmlrnkvr/np7vliqhcbn1cblxuZnVuY3Rpb24gZHJhZ0VuZChldil7XG4gICQoZHJhZ1NvdXJjZSkuY3NzKCdvcGFjaXR5JywnMScpOy8v5oGi5aSN77ya5reh5YyW6KaB56e75Yqo55qE6IqC54K5XG4gIGlmKHBsYWNlaG9sZGVyLnBhcmVudE5vZGUpe1xuICAgIHBsYWNlaG9sZGVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQocGxhY2Vob2xkZXIpOy8v5riF6Zmk6buE6Imy5Y2g5L2N5Z2XXG4gIH1cbn1cblxuZnVuY3Rpb24gZHJvcChldil7XG4gIC8vIGNvbnNvbGUubG9nKCdkcm9wJylcbiAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgdmFyIHNvdXJjZUlEID0gZXYuZGF0YVRyYW5zZmVyLmdldERhdGEoXCJ0ZXh0L3BsYWluXCIpO1xuICB2YXIgdGFyZ2V0Tm9kZT0kKCBldi50YXJnZXQgKS5jbG9zZXN0KFwiLm5vZGVcIikuZ2V0KDApO1xuICAvLyBjb25zb2xlLmxvZyhcInRhcmdldE5vZGVcIix0YXJnZXROb2RlKTtcbiAgdmFyIHNvdXJjZU5vZGU9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc291cmNlSUQpO1xuICBcbiAgaWYoc291cmNlSUQ9PXRhcmdldE5vZGUuaWQpe1xuICAgIHJldHVybjsvL+ebuOWQjOWFg+e0oOS4jeenu+WKqFxuICB9XG4gIC8vIHRhcmdldE5vZGUucGFyZW50RWxlbWVudC5pbnNlcnRCZWZvcmUoc291cmNlTm9kZSx0YXJnZXROb2RlLm5leHRFbGVtZW50U2libGluZyk7IC8v5LiN5YaN6ZyA6KaB77yM5Zug5Li6cmVhY3TkvJrph43loZHoioLngrlcbiAgUHViU3ViLnB1Ymxpc2goXCJUcmVlQnJvd3NlclwiLHttc2c6XCJtb3ZlXCIsZ2lkOnNvdXJjZUlELGJnaWQ6dGFyZ2V0Tm9kZS5pZH0pO1xufVxuZnVuY3Rpb24gYWxsb3dEcm9wKGV2KSB7XG4gICAgZXYucHJldmVudERlZmF1bHQoKTtcbn1cbmZ1bmN0aW9uIGRyYWdvdmVyKGV2KXtcbiAgYWxsb3dEcm9wKGV2KTtcbiAgaWYoZXYudGFyZ2V0LmNsYXNzTmFtZSA9PSBcInBsYWNlaG9sZGVyXCIpIHJldHVybjtcbiAgdmFyIHRhcmdldE5vZGU9JCggZXYudGFyZ2V0ICkuY2xvc2VzdChcIi5ub2RlXCIpLmdldCgwKTtcbiAgb3ZlciA9IHRhcmdldE5vZGU7XG4gIHRhcmdldE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUocGxhY2Vob2xkZXIsIHRhcmdldE5vZGUubmV4dEVsZW1lbnRTaWJsaW5nKTtcbn1cblxuZnVuY3Rpb24gZW5zdXJlRm9jdXNDb2x1bW4oZm9jdXMpe1xuICAkKFwiI1wiK2ZvY3VzKS5jbG9zZXN0KFwiLmNoaWxkcmVuXCIpLmFkZENsYXNzKFwiZm9jdXNcIik7XG59XG5cblxubW9kdWxlLmV4cG9ydHM9e1xuICBzY3JvbGwyY2FyZCxcbiAgZHJhZyxkcm9wLGRyYWdFbmQsXG4gIGRyYWdvdmVyLFxuICBlbnN1cmVGb2N1c0NvbHVtblxufSJdfQ==