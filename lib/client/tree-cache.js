'use strict';

var LRU = require('lru-cache'),
    cache = LRU(5000);
var _ = require('lodash');
// var cache=require('./cache');//LRU cache没有问题，是删除sgid父节点后又误读取了父节点（dgid）
var _api;
var api = {
  read: read,
  read_nodes: read_nodes,
  mk_son_by_data: mk_son_by_data,
  mk_son_by_name: mk_son_by_name,
  mk_brother_by_data: mk_brother_by_data,
  remove: remove,
  update: update,
  mv_as_son: mv_as_son,
  mv_as_brother: mv_as_brother,
  read_big_node: read_big_node
};
function factory(_prefix) {
  _api = require('./tree')(_prefix);
  return api;
}
module.exports = factory;

function clone(obj) {
  if (!obj) {
    return null;
  }
  return JSON.parse(JSON.stringify(obj));
}

function read(gid) {
  var force = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

  if (!gid) {
    console.warn('read:invalid param', gid);
    return Promise.resolve(null);
  }
  if (!force && cache.has(gid)) {
    return Promise.resolve(cache.get(gid));
  }
  return _api.read(gid).then(function (node) {
    cache.set(node._id, node);
    return node;
  });
}

function read_nodes(gids) {
  if (!gids || gids.length === 0) {
    return Promise.resolve([]);
  }
  var cachedNodes = [];
  var unCachedGids = [];
  gids.map(function (gid) {
    if (cache.has(gid)) {
      cachedNodes.push(cache.get(gid));
    } else {
      unCachedGids.push(gid);
    }
  });
  console.log('read_nodes', gids, 'unCachedGids', unCachedGids);
  if (unCachedGids.length === 0) {
    return Promise.resolve(cachedNodes.map(clone)); //全在cache中直接返回 //返回克隆避免缓存被修改
  }
  //否则合并返回
  return _api.read_nodes(unCachedGids).then(function (new_nodes) {
    new_nodes.map(function (node) {
      return cache.set(node._id, node);
    }); //更新nodes cache
    // 调整顺序
    var tmp = {};
    cachedNodes.map(function (node) {
      return tmp[node._id] = node;
    });
    new_nodes.map(function (node) {
      return tmp[node._id] = node;
    });
    var nodes = gids.map(function (gid) {
      return clone(tmp[gid]);
    }); //返回克隆避免缓存被修改
    return _.compact(nodes);
  });
}

function mk_son_by_data(pgid, data) {
  return _api.mk_son_by_data(pgid, data).then(function (node) {
    cache.set(node._id, node); //更新子节点
    cache.del(pgid); //删除旧的父节点
    return node; //返回新的子节点
  });
}

function mk_son_by_name(pgid, name) {
  return _api.mk_son_by_name(pgid, name).then(function (node) {
    cache.set(node._id, node); //更新子节点
    cache.del(pgid); //删除旧的父节点
    return node; //返回新的子节点
  });
}

function _remove_parent_from_cache(gid) {
  return api.read(gid).then(function (node) {
    console.log("_remove_parent_from_cache", node._link.p);
    cache.del(node._link.p);
  });
}

function mk_brother_by_data(bgid, data) {
  return _remove_parent_from_cache(bgid).then(function (_) {
    return _api.mk_brother_by_data(bgid, data);
  });
}

/**
 * 删除节点，并刷新父节点和删除子节点，返回被删除的节点
 * 注意，返回值与api.remove不一致
 */
function remove(gid) {
  //删除某节点后，缓存中该节点的父节点要更新，后续子节点都要删除
  return read(gid).then(function (node) {
    return (//删除前先取出。待会儿还有用。
      //删除节点
      _api.remove(gid).then(function (res) {
        if (node) {
          //如果删除前没有取到当前节点，父节点将无法刷新。
          //递归删除cache中所有子节点
          _remove_all_children(node._link.children);
          cache.del(node._link.p); //刷新父节点
          return node; //返回被删除的节点
        }
        return null;
      })
    );
  });
}

//递归删除cache中所有子节点
function _remove_all_children(gids) {
  if (!gids) {
    return;
  }
  gids.map(function (gid) {
    if (cache.has(gid)) {
      _remove_all_children(cache.get(gid)._link.chilren);
      cache.del(gid);
    }
  });
}

function update(gid, data) {
  return _api.update(gid, data).then(function (node) {
    return cache.set(node._id, node);
  });
}

function mv_as_son(sgid, dgid) {
  cache.del(dgid);
  return _remove_parent_from_cache(sgid).then(function (_) {
    return _api.mv_as_son(sgid, dgid).then(function (node) {
      cache.set(node._id, node);
      return node;
    });
  });
}

function mv_as_brother(sgid, dgid) {
  return _remove_parent_from_cache(dgid) //顺序重要！要先删除目标节点dgid的父节点，因为目标节点dgid可能是sgid的父节点
  .then(function (_) {
    return _remove_parent_from_cache(sgid);
  }).then(function (_) {
    return _api.mv_as_brother(sgid, dgid).then(function (node) {
      cache.set(node._id, node);
      return node;
    });
  });
}

//not cached
function read_big_node(gid) {
  var level = arguments.length <= 1 || arguments[1] === undefined ? 0 : arguments[1];

  return _api.read_big_node(gid, level);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQvdHJlZS1jYWNoZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLElBQUksTUFBTSxRQUFRLFdBQVIsQ0FBVjtBQUFBLElBQWlDLFFBQU8sSUFBSSxJQUFKLENBQXhDO0FBQ0EsSUFBSSxJQUFFLFFBQVEsUUFBUixDQUFOO0FBQ0E7QUFDQSxJQUFJLElBQUo7QUFDQSxJQUFNLE1BQU07QUFDVixZQURVO0FBRVYsd0JBRlU7QUFHVixnQ0FIVTtBQUlWLGdDQUpVO0FBS1Ysd0NBTFU7QUFNVixnQkFOVTtBQU9WLGdCQVBVO0FBUVYsc0JBUlU7QUFTViw4QkFUVTtBQVVWO0FBVlUsQ0FBWjtBQVlBLFNBQVMsT0FBVCxDQUFpQixPQUFqQixFQUEwQjtBQUN4QixTQUFLLFFBQVEsUUFBUixFQUFrQixPQUFsQixDQUFMO0FBQ0EsU0FBTyxHQUFQO0FBQ0Q7QUFDRCxPQUFPLE9BQVAsR0FBaUIsT0FBakI7O0FBRUEsU0FBUyxLQUFULENBQWUsR0FBZixFQUFtQjtBQUNqQixNQUFHLENBQUMsR0FBSixFQUFRO0FBQUMsV0FBTyxJQUFQO0FBQWE7QUFDdEIsU0FBTyxLQUFLLEtBQUwsQ0FBVyxLQUFLLFNBQUwsQ0FBZSxHQUFmLENBQVgsQ0FBUDtBQUNEOztBQUVELFNBQVMsSUFBVCxDQUFjLEdBQWQsRUFBK0I7QUFBQSxNQUFiLEtBQWEseURBQVAsS0FBTzs7QUFDN0IsTUFBRyxDQUFDLEdBQUosRUFBUTtBQUNOLFlBQVEsSUFBUixDQUFhLG9CQUFiLEVBQWtDLEdBQWxDO0FBQ0EsV0FBTyxRQUFRLE9BQVIsQ0FBZ0IsSUFBaEIsQ0FBUDtBQUNEO0FBQ0QsTUFBSSxDQUFDLEtBQUQsSUFBVSxNQUFNLEdBQU4sQ0FBVSxHQUFWLENBQWQsRUFBOEI7QUFBQyxXQUFPLFFBQVEsT0FBUixDQUFnQixNQUFNLEdBQU4sQ0FBVSxHQUFWLENBQWhCLENBQVA7QUFBd0M7QUFDdkUsU0FBTyxLQUFLLElBQUwsQ0FBVSxHQUFWLEVBQWUs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LENBQVI7QUFBQSxHQUE1QixDQUFQO0FBQ0E7O0FBRUQsU0FBVSxTQUFWLENBQW9CLElBQXBCLEVBQXlCLElBQXpCLEVBQThCO0FBQzVCLFFBQU0sR0FBTixDQUFVLElBQVY7QUFDQSxTQUFPLDBCQUEwQixJQUExQixFQUFnQyxJQUFoQyxDQUFxQztBQUFBLFdBQUcsS0FBSyxTQUFMLENBQWUsSUFBZixFQUFvQixJQUFwQixFQUEwQixJQUExQixDQUErQixnQkFBTTtBQUNsRixZQUFNLEdBQU4sQ0FBVSxLQUFLLEdBQWYsRUFBbUIsSUFBbkI7QUFDQSxhQUFPLElBQVA7QUFDRCxLQUg4QyxDQUFIO0FBQUEsR0FBckMsQ0FBUDtBQUlEOztBQUVELFNBQVUsYUFBVixDQUF3QixJQUF4QixFQUE2QixJQUE3QixFQUFrQztBQUNoQyxTQUFPLDBCQUEwQixJQUExQixFQUFnQztBQUFoQyxHQUNOLElBRE0sQ0FDRDtBQUFBLFdBQUcsMEJBQTBCLElBQTFCLENBQUg7QUFBQSxHQURDLEVBRU4sSUFGTSxDQUVEO0FBQUEsV0FBRyxLQUFLLGFBQUwsQ0FBbUIsSUFBbkIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsQ0FBbUMsZ0JBQU07QUFDaEQsWUFBTSxHQUFOLENBQVUsS0FBSyxHQUFmLEVBQW1CLElBQW5CO0FBQ0EsYUFBTyxJQUFQO0FBQ0QsS0FIUSxDQUFIO0FBQUEsR0FGQyxDQUFQO0FBTUQ7O0FBRUQ7QUFDQSxTQUFTLGFBQVQsQ0FBdUIsR0FBdkIsRUFBb0M7QUFBQSxNQUFULEtBQVMseURBQUgsQ0FBRzs7QUFDbEMsU0FBTyxLQUFLLGFBQUwsQ0FBbUIsR0FBbkIsRUFBdUIsS0FBdkIsQ0FBUDtBQUNEIiwiZmlsZSI6InRyZWUtY2FjaGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgTFJVID0gcmVxdWlyZSgnbHJ1LWNhY2hlJykgLCBjYWNoZT0gTFJVKDUwMDApOyBcclxudmFyIF89cmVxdWlyZSgnbG9kYXNoJyk7XHJcbi8vIHZhciBjYWNoZT1yZXF1aXJlKCcuL2NhY2hlJyk7Ly9MUlUgY2FjaGXmsqHmnInpl67popjvvIzmmK/liKDpmaRzZ2lk54i26IqC54K55ZCO5Y+I6K+v6K+75Y+W5LqG54i26IqC54K577yIZGdpZO+8iVxyXG52YXIgX2FwaTtcclxuY29uc3QgYXBpID0ge1xyXG4gIHJlYWQsXHJcbiAgcmVhZF9ub2RlcyxcclxuICBta19zb25fYnlfZGF0YSxcclxuICBta19zb25fYnlfbmFtZSxcclxuICBta19icm90aGVyX2J5X2RhdGEsXHJcbiAgcmVtb3ZlLFxyXG4gIHVwZGF0ZSxcclxuICBtdl9hc19zb24sXHJcbiAgbXZfYXNfYnJvdGhlcixcclxuICByZWFkX2JpZ19ub2RlLFxyXG59O1xyXG5mdW5jdGlvbiBmYWN0b3J5KF9wcmVmaXgpIHtcclxuICBfYXBpPXJlcXVpcmUoJy4vdHJlZScpKF9wcmVmaXgpO1xyXG4gIHJldHVybiBhcGk7XHJcbn1cclxubW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5O1xyXG5cclxuZnVuY3Rpb24gY2xvbmUob2JqKXtcclxuICBpZighb2JqKXtyZXR1cm4gbnVsbDt9XHJcbiAgcmV0dXJuIEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkob2JqKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlYWQoZ2lkLGZvcmNlPWZhbHNlKSB7XHJcbiAgaWYoIWdpZCl7XHJcbiAgICBjb25zb2xlLndhcm4oJ3JlYWQ6aW52YWxpZCBwYXJhbScsZ2lkKTtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XHJcbiAgfVxyXG4gIGlmICghZm9yY2UgJiYgY2FjaGUuaGFzKGdpZCkpIHtyZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGNhY2hlLmdldChnaWQpKTt9XHJcbiAgcmV0dXJuIF9hcGkucmVhZChnaWQpLnRoZW4obm9kZSA9PiB7XHJcbiAgICBjYWNoZS5zZXQobm9kZS5faWQsbm9kZSk7XHJcbiAgICByZXR1cm4gbm9kZTtcclxuICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gcmVhZF9ub2RlcyhnaWRzKSB7XHJcbiAgaWYgKCFnaWRzIHx8IGdpZHMubGVuZ3RoID09PSAwKSB7cmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7fVxyXG4gIGxldCBjYWNoZWROb2RlcyA9IFtdO1xyXG4gIGxldCB1bkNhY2hlZEdpZHMgPSBbXTtcclxuICBnaWRzLm1hcChnaWQgPT4ge1xyXG4gICAgaWYgKGNhY2hlLmhhcyhnaWQpKSB7XHJcbiAgICAgIGNhY2hlZE5vZGVzLnB1c2goY2FjaGUuZ2V0KGdpZCkpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdW5DYWNoZWRHaWRzLnB1c2goZ2lkKTtcclxuICAgIH1cclxuICB9KTtcclxuICBjb25zb2xlLmxvZygncmVhZF9ub2RlcycsZ2lkcywndW5DYWNoZWRHaWRzJyx1bkNhY2hlZEdpZHMpXHJcbiAgaWYgKHVuQ2FjaGVkR2lkcy5sZW5ndGggPT09IDApIHtcclxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoY2FjaGVkTm9kZXMubWFwKGNsb25lKSk7IC8v5YWo5ZyoY2FjaGXkuK3nm7TmjqXov5Tlm54gLy/ov5Tlm57lhYvpmobpgb/lhY3nvJPlrZjooqvkv67mlLlcclxuICB9XHJcbiAgLy/lkKbliJnlkIjlubbov5Tlm55cclxuICByZXR1cm4gX2FwaS5yZWFkX25vZGVzKHVuQ2FjaGVkR2lkcykudGhlbihuZXdfbm9kZXMgPT4ge1xyXG4gICAgbmV3X25vZGVzLm1hcChub2RlID0+IGNhY2hlLnNldChub2RlLl9pZCxub2RlKSk7IC8v5pu05pawbm9kZXMgY2FjaGVcclxuICAgIC8vIOiwg+aVtOmhuuW6j1xyXG4gICAgdmFyIHRtcD17fTtcclxuICAgIGNhY2hlZE5vZGVzLm1hcChub2RlPT50bXBbbm9kZS5faWRdPW5vZGUpO1xyXG4gICAgbmV3X25vZGVzLm1hcChub2RlPT50bXBbbm9kZS5faWRdPW5vZGUpO1xyXG4gICAgdmFyIG5vZGVzPSBnaWRzLm1hcChnaWQ9PmNsb25lKHRtcFtnaWRdKSk7IC8v6L+U5Zue5YWL6ZqG6YG/5YWN57yT5a2Y6KKr5L+u5pS5XHJcbiAgICByZXR1cm4gXy5jb21wYWN0KG5vZGVzKTtcclxuICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWtfc29uX2J5X2RhdGEocGdpZCwgZGF0YSkge1xyXG4gIHJldHVybiBfYXBpLm1rX3Nvbl9ieV9kYXRhKHBnaWQsIGRhdGEpLnRoZW4obm9kZSA9PntcclxuICAgIGNhY2hlLnNldChub2RlLl9pZCxub2RlKTsvL+abtOaWsOWtkOiKgueCuVxyXG4gICAgY2FjaGUuZGVsKHBnaWQpOy8v5Yig6Zmk5pen55qE54i26IqC54K5XHJcbiAgICByZXR1cm4gbm9kZTsvL+i/lOWbnuaWsOeahOWtkOiKgueCuVxyXG4gIH0pO1xyXG59XHJcblxyXG5cclxuZnVuY3Rpb24gbWtfc29uX2J5X25hbWUocGdpZCwgbmFtZSkge1xyXG4gIHJldHVybiBfYXBpLm1rX3Nvbl9ieV9uYW1lKHBnaWQsIG5hbWUpLnRoZW4obm9kZSA9PntcclxuICAgIGNhY2hlLnNldChub2RlLl9pZCxub2RlKTsvL+abtOaWsOWtkOiKgueCuVxyXG4gICAgY2FjaGUuZGVsKHBnaWQpOy8v5Yig6Zmk5pen55qE54i26IqC54K5XHJcbiAgICByZXR1cm4gbm9kZTsvL+i/lOWbnuaWsOeahOWtkOiKgueCuVxyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBfcmVtb3ZlX3BhcmVudF9mcm9tX2NhY2hlKGdpZCl7XHJcbiAgcmV0dXJuIGFwaS5yZWFkKGdpZCkudGhlbihub2RlPT57XHJcbiAgICBjb25zb2xlLmxvZyhcIl9yZW1vdmVfcGFyZW50X2Zyb21fY2FjaGVcIixub2RlLl9saW5rLnApXHJcbiAgICBjYWNoZS5kZWwobm9kZS5fbGluay5wKTtcclxuICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWtfYnJvdGhlcl9ieV9kYXRhKGJnaWQsIGRhdGEpIHtcclxuICByZXR1cm4gX3JlbW92ZV9wYXJlbnRfZnJvbV9jYWNoZShiZ2lkKS50aGVuKF89Pl9hcGkubWtfYnJvdGhlcl9ieV9kYXRhKGJnaWQsIGRhdGEpKTtcclxufVxyXG5cclxuXHJcbi8qKlxyXG4gKiDliKDpmaToioLngrnvvIzlubbliLfmlrDniLboioLngrnlkozliKDpmaTlrZDoioLngrnvvIzov5Tlm57ooqvliKDpmaTnmoToioLngrlcclxuICog5rOo5oSP77yM6L+U5Zue5YC85LiOYXBpLnJlbW92ZeS4jeS4gOiHtFxyXG4gKi9cclxuZnVuY3Rpb24gcmVtb3ZlKGdpZCkge1xyXG4gIC8v5Yig6Zmk5p+Q6IqC54K55ZCO77yM57yT5a2Y5Lit6K+l6IqC54K555qE54i26IqC54K56KaB5pu05paw77yM5ZCO57ut5a2Q6IqC54K56YO96KaB5Yig6ZmkXHJcbiAgcmV0dXJuIHJlYWQoZ2lkKS50aGVuKG5vZGUgPT4gLy/liKDpmaTliY3lhYjlj5blh7rjgILlvoXkvJrlhL/ov5jmnInnlKjjgIJcclxuICAgIC8v5Yig6Zmk6IqC54K5XHJcbiAgICBfYXBpLnJlbW92ZShnaWQpLnRoZW4ocmVzID0+IHtcclxuICAgICAgaWYgKG5vZGUpIHsgLy/lpoLmnpzliKDpmaTliY3msqHmnInlj5bliLDlvZPliY3oioLngrnvvIzniLboioLngrnlsIbml6Dms5XliLfmlrDjgIJcclxuICAgICAgICAvL+mAkuW9kuWIoOmZpGNhY2hl5Lit5omA5pyJ5a2Q6IqC54K5XHJcbiAgICAgICAgX3JlbW92ZV9hbGxfY2hpbGRyZW4obm9kZS5fbGluay5jaGlsZHJlbik7XHJcbiAgICAgICAgY2FjaGUuZGVsKG5vZGUuX2xpbmsucCk7Ly/liLfmlrDniLboioLngrlcclxuICAgICAgICByZXR1cm4gbm9kZTsvL+i/lOWbnuiiq+WIoOmZpOeahOiKgueCuVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfSlcclxuICApO1xyXG59XHJcblxyXG4vL+mAkuW9kuWIoOmZpGNhY2hl5Lit5omA5pyJ5a2Q6IqC54K5XHJcbmZ1bmN0aW9uIF9yZW1vdmVfYWxsX2NoaWxkcmVuKGdpZHMpIHtcclxuICBpZiAoIWdpZHMpIHtyZXR1cm47fVxyXG4gIGdpZHMubWFwKGdpZCA9PiB7XHJcbiAgICBpZiAoY2FjaGUuaGFzKGdpZCkpIHtcclxuICAgICAgX3JlbW92ZV9hbGxfY2hpbGRyZW4oY2FjaGUuZ2V0KGdpZCkuX2xpbmsuY2hpbHJlbik7XHJcbiAgICAgIGNhY2hlLmRlbChnaWQpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGUoZ2lkLCBkYXRhKSB7XHJcbiByZXR1cm4gX2FwaS51cGRhdGUoZ2lkLCBkYXRhKS50aGVuKG5vZGUgPT4gY2FjaGUuc2V0KG5vZGUuX2lkLCBub2RlKSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uICBtdl9hc19zb24oc2dpZCxkZ2lkKXtcclxuICBjYWNoZS5kZWwoZGdpZCk7XHJcbiAgcmV0dXJuIF9yZW1vdmVfcGFyZW50X2Zyb21fY2FjaGUoc2dpZCkudGhlbihfPT5fYXBpLm12X2FzX3NvbihzZ2lkLGRnaWQpLnRoZW4obm9kZT0+e1xyXG4gICAgY2FjaGUuc2V0KG5vZGUuX2lkLG5vZGUpO1xyXG4gICAgcmV0dXJuIG5vZGU7XHJcbiAgfSkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiAgbXZfYXNfYnJvdGhlcihzZ2lkLGRnaWQpe1xyXG4gIHJldHVybiBfcmVtb3ZlX3BhcmVudF9mcm9tX2NhY2hlKGRnaWQpIC8v6aG65bqP6YeN6KaB77yB6KaB5YWI5Yig6Zmk55uu5qCH6IqC54K5ZGdpZOeahOeItuiKgueCue+8jOWboOS4uuebruagh+iKgueCuWRnaWTlj6/og73mmK9zZ2lk55qE54i26IqC54K5XHJcbiAgLnRoZW4oXz0+X3JlbW92ZV9wYXJlbnRfZnJvbV9jYWNoZShzZ2lkKSlcclxuICAudGhlbihfPT5fYXBpLm12X2FzX2Jyb3RoZXIoc2dpZCxkZ2lkKS50aGVuKG5vZGU9PntcclxuICAgIGNhY2hlLnNldChub2RlLl9pZCxub2RlKTtcclxuICAgIHJldHVybiBub2RlO1xyXG4gIH0pKTtcclxufVxyXG5cclxuLy9ub3QgY2FjaGVkXHJcbmZ1bmN0aW9uIHJlYWRfYmlnX25vZGUoZ2lkLGxldmVsPTApIHtcclxuICByZXR1cm4gX2FwaS5yZWFkX2JpZ19ub2RlKGdpZCxsZXZlbCk7XHJcbn0iXX0=